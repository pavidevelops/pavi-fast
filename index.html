<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Login</title>

  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#10b981">

  <!-- Roboto -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@100..900&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#f8fdf9; --card:#fff; --text:#1a472a; --muted:#5d7a6d;
      --primary:#10b981; --primary-600:#0da271; --primary-700:#0b8c61;
      --border:#d1fae5;
      --ok-bg:#ecfdf5; --ok:#065f46; --ok-br:#a7f3d0;
      --err-bg:#fef2f2; --err:#991b1b; --err-br:#fecaca;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:Roboto,system-ui;
      background:var(--bg); min-height:100vh;
      display:flex; align-items:center; justify-content:center;
      padding:24px; color:var(--text);
    }
    .card{
      width:100%; max-width:420px; background:var(--card);
      border-radius:20px; border:1px solid var(--border);
      padding:36px 32px;
      box-shadow:0 15px 35px rgba(16,185,129,.1);
    }
    .logo{display:flex;justify-content:center;margin-bottom:20px}
    .logo img{width:240px;max-width:100%}
    h1{text-align:center;margin:0 0 8px;font-size:28px}
    .subtitle{text-align:center;color:var(--muted);margin-bottom:24px}
    label{display:block;font-weight:600;margin:12px 0 8px}
    .field{position:relative}
    input{
      width:100%; padding:14px 48px 14px 16px;
      border-radius:12px; border:2px solid var(--border);
      background:#f8fdf9; font-size:16px;
    }
    input:focus{border-color:var(--primary);background:#fff}
    .toggle-password{
      position:absolute; right:12px; top:50%;
      transform:translateY(-50%);
      background:none;border:0;font-size:20px;cursor:pointer;
    }
    .btn{
      width:100%; margin-top:16px; padding:16px;
      border:0; border-radius:14px;
      background:linear-gradient(135deg,var(--primary),var(--primary-600));
      color:#fff; font-weight:700; font-size:16px;
      cursor:pointer;
    }
    .btn[disabled]{opacity:.7}
    .msg{
      display:none; margin-top:16px; padding:14px;
      border-radius:12px; font-size:14px;
    }
    .msg.ok{background:var(--ok-bg);color:var(--ok);border:2px solid var(--ok-br)}
    .msg.err{background:var(--err-bg);color:var(--err);border:2px solid var(--err-br)}
    .link{text-align:center;margin-top:20px;padding-top:16px;border-top:1px solid #e5f7ef}
    .link a{color:var(--primary-700);text-decoration:none;font-weight:600}
    .hint{color:var(--muted);font-size:12px;margin-top:8px;font-style:italic}
  </style>
</head>

<body>
<main class="card">
  <div class="logo">
    <img src="logo.png" alt="PAVI Fast">
  </div>

  <h1>Entrar</h1>
  <p class="subtitle">Acesse sua conta para continuar</p>

  <form id="loginForm" novalidate>
    <label>Usu√°rio</label>
    <input id="username" type="text" placeholder="seu@email.com">

    <label>Senha</label>
    <div class="field">
      <input id="password" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
      <button type="button" class="toggle-password">üëÅÔ∏è</button>
    </div>
    <div class="hint">Dica: verifique se o Caps Lock est√° desligado.</div>

    <button id="submitBtn" class="btn" type="submit">Entrar</button>

    <div id="msgOk" class="msg ok"></div>
    <div id="msgErr" class="msg err"></div>

    <div class="link">
      <a href="primeiro_acesso.html">Primeiro acesso</a>
    </div>
  </form>
</main>

<script>
/* ================================
   CONFIG
================================ */
const WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbzbUN-2Heaogs0140LZGJEctnNW85aTxHJmGPatf-rTn1Ze_JM6bCA_BsVRvMiYPwuLDA/exec';
const LS_SESSION_V1 = 'PAVI_FAST_SESSION_V1';
const SESSION_MAX_MS = 30 * 24 * 60 * 60 * 1000;

/* ================================
   OFFLINE GATE (ANTES DE TUDO)
================================ */
(function offlineGate(){
  try{
    if(navigator.onLine) return;
    const raw = localStorage.getItem(LS_SESSION_V1);
    if(!raw) return;
    const s = JSON.parse(raw);
    if(!s?.lastLoginAt) return;
    if(Date.now() - s.lastLoginAt > SESSION_MAX_MS) return;
    location.replace('poslog.html');
  }catch(e){}
})();

/* ================================
   HELPERS
================================ */
const $ = id => document.getElementById(id);
const show = (el,msg)=>{el.textContent=msg;el.style.display='block'};
const hide = ()=>{$('msgOk').style.display='none';$('msgErr').style.display='none'};
const validSession = s => s && (Date.now()-s.lastLoginAt)<=SESSION_MAX_MS;

/* ================================
   UI
================================ */
document.querySelector('.toggle-password').onclick = ()=>{
  const p=$('password'); p.type=p.type==='password'?'text':'password';
};

/* ================================
   LOGIN
================================ */
$('loginForm').addEventListener('submit', async e=>{
  e.preventDefault(); hide();

  const u=$('username').value.trim();
  const p=$('password').value;
  if(!u||!p){show($('msgErr'),'Informe usu√°rio e senha.');return;}

  // üîí OFFLINE: N√ÉO FAZ FETCH
  if(!navigator.onLine){
    const s=JSON.parse(localStorage.getItem(LS_SESSION_V1)||'null');
    if(validSession(s)){
      show($('msgOk'),'Modo offline: entrando...');
      setTimeout(()=>location.replace('poslog.html'),300);
      return;
    }
    show($('msgErr'),'Sem internet. Conecte-se para o primeiro acesso.');
    return;
  }

  $('submitBtn').disabled=true;

  try{
    const body=new URLSearchParams({action:'login',usuario:u,senha:p});
    const r=await fetch(WEBAPP_URL,{method:'POST',body});
    const j=await r.json();
    if(j.status!=='OK') throw new Error(j.mensagem||'Falha');

    if(!j.lotes||!j.lotes.length){
      show($('msgErr'),'Sem lote definido.');
      return;
    }

    localStorage.setItem('PAVI_FAST_USER',u);
    localStorage.setItem('PAVI_FAST_NAME',j.nome||u);
    localStorage.setItem(LS_SESSION_V1,JSON.stringify({
      usuario:u,nome:j.nome||u,lotes:j.lotes,lastLoginAt:Date.now()
    }));

    if(window.Android?.loginOk) window.Android.loginOk();

    show($('msgOk'),'Bem-vindo! Redirecionando...');
    setTimeout(()=>location.replace('poslog.html'),600);

  }catch(err){
    show($('msgErr'),'N√£o foi poss√≠vel entrar.');
  }finally{
    $('submitBtn').disabled=false;
  }
});
</script>

<script>
if('serviceWorker' in navigator){
  navigator.serviceWorker.register('./sw.js').catch(()=>{});
}
</script>

</body>
</html>
