<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Login</title>

  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#10b981">

  <!-- Roboto -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@100..900&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#f8fdf9;
      --card:#ffffff;
      --text:#1a472a;
      --muted:#5d7a6d;
      --primary:#10b981;
      --primary-600:#0da271;
      --primary-700:#0b8c61;
      --border:#d1fae5;
      --ok-bg:#ecfdf5; --ok:#065f46; --ok-br:#a7f3d0;
      --err-bg:#fef2f2; --err:#991b1b; --err-br:#fecaca;
    }
    *{ box-sizing:border-box }
    body{
      margin:0;
      font-family:Roboto,system-ui,Arial;
      background:var(--bg);
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:24px;
      color:var(--text);
    }
    .card{
      width:100%;
      max-width:420px;
      background:var(--card);
      border-radius:20px;
      padding:36px 32px;
      border:1px solid var(--border);
      box-shadow:0 15px 35px rgba(16,185,129,.12);
    }
    .logo{display:flex;justify-content:center;margin-bottom:20px}
    .logo img{width:240px;max-width:100%}
    h1{text-align:center;margin:0 0 8px}
    .subtitle{text-align:center;color:var(--muted);margin-bottom:24px}
    label{font-weight:600;margin:12px 0 6px;display:block}
    .field{position:relative}
    input{
      width:100%;
      padding:14px 48px 14px 16px;
      border-radius:12px;
      border:2px solid var(--border);
      background:#f8fdf9;
      font-size:16px;
      outline:none;
    }
    input:focus{
      border-color: rgba(16,185,129,.55);
      box-shadow: 0 0 0 4px rgba(16,185,129,.12);
    }
    .toggle-password{
      position:absolute;right:10px;top:50%;
      transform:translateY(-50%);
      border:0;background:none;font-size:18px;cursor:pointer
    }
    .btn{
      width:100%;
      margin-top:16px;
      padding:16px;
      border:0;
      border-radius:14px;
      background:linear-gradient(135deg,var(--primary),var(--primary-600));
      color:#fff;
      font-weight:700;
      font-size:16px;
      cursor:pointer;
    }
    .btn:disabled{opacity:.65;cursor:not-allowed}
    .msg{display:none;margin-top:16px;padding:14px;border-radius:12px;font-size:14px}
    .msg.ok{background:var(--ok-bg);color:var(--ok);border:2px solid var(--ok-br)}
    .msg.err{background:var(--err-bg);color:var(--err);border:2px solid var(--err-br)}
    .link{text-align:center;margin-top:20px}
    .link a{color:var(--primary-700);text-decoration:none;font-weight:600}
  </style>
</head>
<body>

<main class="card">
  <div class="logo">
    <img src="logo.png" alt="PAVI Fast">
  </div>

  <h1>Entrar</h1>
  <p class="subtitle">Acesse sua conta para continuar</p>

  <form id="loginForm" novalidate>
    <label>Usu√°rio</label>
    <input id="username" autocomplete="username" required placeholder="email@empresa.com">

    <label>Senha</label>
    <div class="field">
      <input id="password" type="password" autocomplete="current-password" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
      <button type="button" class="toggle-password">üëÅÔ∏è</button>
    </div>

    <button class="btn" id="submitBtn" type="submit">Entrar</button>

    <div id="msgOk" class="msg ok"></div>
    <div id="msgErr" class="msg err"></div>

    <div class="link">
      <a href="primeiro_acesso.html" id="firstAccess">Primeiro acesso</a>
    </div>
  </form>
</main>

<script>
document.addEventListener('DOMContentLoaded', () => {

  const API_URL = "https://script.google.com/macros/s/AKfycbzbUN-2Heaogs0140LZGJEctnNW85aTxHJmGPatf-rTn1Ze_JM6bCA_BsVRvMiYPwuLDA/exec";

  const form = document.getElementById('loginForm');
  const btn  = document.getElementById('submitBtn');
  const ok   = document.getElementById('msgOk');
  const err  = document.getElementById('msgErr');

  const username = document.getElementById('username');
  const password = document.getElementById('password');

  const FIRST_OK_KEY = 'PAVI_FAST_FIRST_OK';
  const LS_SESSION_V1 = 'PAVI_FAST_SESSION_V1';

  function show(el, txt){ el.textContent = txt; el.style.display='block'; }
  function hide(){ ok.style.display='none'; err.style.display='none'; }

  document.querySelector('.toggle-password').onclick = () => {
    password.type = (password.type === 'password') ? 'text' : 'password';
  };

  function getLocalSession(){
    try{
      const s = localStorage.getItem(LS_SESSION_V1);
      return s ? JSON.parse(s) : null;
    }catch{ return null; }
  }

  form.addEventListener('submit', async (e)=>{
    e.preventDefault();
    hide();

    const firstOk = localStorage.getItem(FIRST_OK_KEY) === '1';
    const localSession = getLocalSession();

    /* ‚úÖ LOGIN OFFLINE PERMITIDO SE J√Å EXISTIR SESS√ÉO */
    if(!navigator.onLine){
      if(firstOk && localSession){
        window.location.replace((localSession.destino || 'poslog.html'));
        return;
      }
      show(err,'Sem internet. Conecte-se para o primeiro acesso.');
      return;
    }

    const u = username.value.trim();
    const s = password.value.trim();

    if(!u || !u.includes("@")){
      show(err,"Informe um e-mail v√°lido.");
      return;
    }
    if(!s){
      show(err,"Informe a senha.");
      return;
    }

    btn.disabled = true;
    btn.textContent = 'Entrando...';

    try{
      const body = new URLSearchParams({
        action:'login',
        usuario:u,
        senha:s
      });

      const r = await fetch(API_URL,{ method:'POST', body });
      const t = await r.text();
      const d = JSON.parse(t);

      if(d.status !== 'OK') throw new Error(d.mensagem || 'Login inv√°lido');

      localStorage.setItem(FIRST_OK_KEY,'1');

      const destino = (d.destino || '').toLowerCase().trim();
      localStorage.setItem(LS_SESSION_V1, JSON.stringify({
        usuario:d.email || u,
        nome:d.nome || u,
        lotes:d.lotes || [],
        destino:destino,
        lastLoginAt:Date.now()
      }));

      show(ok,'Login OK. Entrando...');
      setTimeout(()=>location.replace(destino || 'poslog.html'),300);

    }catch(e){
      show(err,'N√£o foi poss√≠vel entrar: ' + e.message);
    }finally{
      btn.disabled=false;
      btn.textContent='Entrar';
    }
  });
});
</script>

</body>
</html>
