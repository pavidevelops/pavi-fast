<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=no" />
  <title>PAVI FAST — TST (Acidente)</title>

  <style>
    /* ============================
       FUNNEL SANS — LOCAL (.ttf)
    ============================ */
    @font-face{font-family:'FunnelSans';src:url('FunnelSans-Regular.ttf') format('truetype');font-weight:400;font-style:normal;font-display:swap;}
    @font-face{font-family:'FunnelSans';src:url('FunnelSans-Medium.ttf') format('truetype');font-weight:500;font-style:normal;font-display:swap;}
    @font-face{font-family:'FunnelSans';src:url('FunnelSans-SemiBold.ttf') format('truetype');font-weight:600;font-style:normal;font-display:swap;}
    @font-face{font-family:'FunnelSans';src:url('FunnelSans-Bold.ttf') format('truetype');font-weight:700;font-style:normal;font-display:swap;}

    :root{
      --bg:#f8fdf9;
      --card:#ffffff;
      --text:#123322;
      --muted:#5d7a6d;
      --primary:#10b981;
      --primary-600:#0da271;
      --border:#d1fae5;
      --shadow:0 10px 25px rgba(16,185,129,.10);
      --radius:18px;

      --ok-bg:#ecfdf5; --ok:#065f46; --ok-br:#a7f3d0;
      --warn-bg:#fffbeb; --warn:#92400e; --warn-br:#fde68a;
      --err-bg:#fef2f2; --err:#991b1b; --err-br:#fecaca;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:'FunnelSans', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:var(--bg);
      color:var(--text);
    }
    .wrap{max-width:820px;margin:0 auto;padding:18px 14px 28px}

    .top{
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      margin:10px 0 14px;
    }
    .brand{display:flex;align-items:center;gap:10px}
    .logo{
      width:40px;height:40px;border-radius:12px;overflow:hidden;
      border:1px solid var(--border); background:#fff; box-shadow:var(--shadow);
      display:grid;place-items:center;
    }
    .logo img{width:100%;height:100%;object-fit:cover}
    .title h1{margin:0;font-size:18px;font-weight:800}
    .title p{margin:3px 0 0;font-size:12px;color:var(--muted)}

    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:10px 12px;border-radius:999px;
      border:1px solid var(--border);
      background:#fff;
      box-shadow:var(--shadow);
      font-size:12px;
      user-select:none;
      white-space:nowrap;
    }
    .dot{width:10px;height:10px;border-radius:50%}
    .dot.ok{background:#10b981}
    .dot.off{background:#f59e0b}

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:16px;
    }

    .progressRow{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      margin-bottom:10px;
    }
    .progressText{font-size:12px;color:var(--muted)}
    .bar{
      width:100%;
      height:10px;
      border-radius:999px;
      background:#eaf7ef;
      border:1px solid var(--border);
      overflow:hidden;
    }
    .bar > div{
      height:100%;
      width:0%;
      background:var(--primary);
      transition:width .2s ease;
    }

    label{
      display:block;
      font-size:14px;
      font-weight:900;
      margin:6px 0 8px;
      letter-spacing:.2px;
    }
    .req{color:#dc2626;font-weight:900;margin-left:6px}

    .hint{font-size:12px;color:var(--muted);margin-top:-2px;margin-bottom:10px}

    input, select, textarea{
      width:100%;
      padding:14px 12px;
      border-radius:14px;
      border:1px solid var(--border);
      background:#fff;
      font-family:inherit;
      font-size:15px;
      outline:none;
      transition:.15s ease;
    }
    textarea{min-height:110px;resize:vertical}
    input:focus, select:focus, textarea:focus{
      border-color: rgba(16,185,129,.55);
      box-shadow: 0 0 0 4px rgba(16,185,129,.12);
    }

    .actions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:14px;
    }
    .btn{
      appearance:none;border:0;cursor:pointer;
      border-radius:14px;
      padding:12px 14px;
      font-family:inherit;
      font-weight:900;
      font-size:14px;
      display:inline-flex;align-items:center;justify-content:center;
      transition:.15s ease;
      user-select:none;
    }
    .btnPrimary{background:var(--primary);color:#fff}
    .btnSecondary{background:#fff;color:var(--text);border:1px solid var(--border)}
    .btnGhost{background:transparent;color:var(--text);border:1px dashed rgba(18,51,34,.22)}
    .btn:disabled{opacity:.55;cursor:not-allowed}

    .alert{margin-top:12px;padding:12px;border-radius:14px;border:1px solid var(--border);font-size:13px;display:none}
    .alert.ok{background:var(--ok-bg);color:var(--ok);border-color:var(--ok-br)}
    .alert.warn{background:var(--warn-bg);color:var(--warn);border-color:var(--warn-br)}
    .alert.err{background:var(--err-bg);color:var(--err);border-color:var(--err-br)}

    .review{
      margin-top:10px;
      border-top:1px solid var(--border);
      padding-top:12px;
    }
    .review h3{margin:0 0 8px;font-size:14px;font-weight:900}
    .list{display:grid;gap:8px}
    .item{
      border:1px solid var(--border);
      border-radius:14px;
      padding:10px 12px;
      background:#fff;
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:flex-start;
      cursor:pointer;
    }
    .item b{display:block;font-size:12px;color:var(--muted);font-weight:800}
    .item span{display:block;font-size:13px;font-weight:800;color:var(--text);word-break:break-word}
    .item small{color:var(--muted);font-size:12px;font-weight:800}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <div class="logo"><img src="logo.png" alt="PAVI"></div>
        <div class="title">
          <h1>Registro de Acidente — TST</h1>
          <p>Modo dinâmico (1 campo por vez) • N/A para pular • Offline-first</p>
        </div>
      </div>

      <div class="pill" title="Conexão">
        <span class="dot off" id="netDot"></span>
        <span id="netText">Offline</span>
      </div>
    </div>

    <div class="card">
      <div class="progressRow">
        <div class="progressText" id="progressText">—</div>
        <div style="flex:1">
          <div class="bar"><div id="barFill"></div></div>
        </div>
      </div>

      <div id="stepArea"></div>

      <div class="actions" id="actions">
        <button class="btn btnSecondary" id="btnBack" type="button">Voltar</button>
        <button class="btn btnGhost" id="btnNA" type="button">N/A (pular)</button>
        <button class="btn btnPrimary" id="btnOk" type="button">OK / Próximo</button>
      </div>

      <div class="alert ok" id="okBox"></div>
      <div class="alert warn" id="warnBox"></div>
      <div class="alert err" id="errBox"></div>
    </div>
  </div>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycby4Fjn2Cd083r9y9-RAgY6kDBlGb-Yzw7o82MljeWxlkW2OPofQR4KIvmNXx-PRbcz0rQ/exec";
    const ACTION = "submit_tst";
    const QUEUE_KEY = "PAVI_FAST_TST_QUEUE_V1";

    const $ = (id)=>document.getElementById(id);

    const steps = [
      { key:"matricula", label:"MATRÍCULA DO FUNCIONÁRIO", type:"text", required:true, placeholder:"Ex.: 12345", inputmode:"numeric" },
      { key:"nome_funcionario", label:"NOME DO FUNCIONÁRIO", type:"text", required:true, placeholder:"Nome completo" },

      { key:"idade", label:"IDADE", type:"number", placeholder:"Ex.: 34" },
      { key:"funcao", label:"FUNÇÃO", type:"text", placeholder:"Ex.: Coletor" },
      { key:"setor", label:"SETOR", type:"text", placeholder:"Ex.: Operação" },

      { key:"data_acidente", label:"DATA DO ACIDENTE", type:"date" },

      { key:"regiao", label:"REGIÃO", type:"select", options:["PARANAGUÁ","CIANORTE","MARINGÁ","OUTRO"] },
      { key:"regiao_outro", label:"REGIÃO (OUTRO) — ESCREVER", type:"text", placeholder:"Descreva a região",
        showIf:(a)=>a.regiao==="OUTRO", requiredIf:(a)=>a.regiao==="OUTRO"
      },

      { key:"gravidade", label:"GRAVIDADE", type:"select", options:["LEVE","SÉRIO","GRAVE"] },
      { key:"periodo_evento", label:"PERÍODO DO EVENTO", type:"select",
        options:[
          "MANHÃ (05:00 às 12:00)",
          "TARDE (12:01 às 18:00)",
          "NOITE (18:01 às 23:59)",
          "MADRUGADA (00:00 às 04:59)"
        ]
      },

      { key:"tipo_lesao", label:"TIPO DE LESÃO", type:"select",
        options:["ESCORIAÇÃO","TORÇÃO","CORTE/PERFURAÇÃO","MORDIDA","OUTROS"]
      },
      { key:"tipo_lesao_outro", label:"TIPO DE LESÃO (OUTROS) — DESCREVER", type:"text", placeholder:"Descreva a lesão",
        showIf:(a)=>a.tipo_lesao==="OUTROS", requiredIf:(a)=>a.tipo_lesao==="OUTROS"
      },

      { key:"parte_corpo", label:"PARTE DO CORPO ATINGIDO", type:"select",
        options:["PERNA/JOELHO","SEM LESÃO","OMBRO","MULTIPLAS PARTES","PÉ","DEDOS","BRAÇO","PERNA","OUTRO"]
      },
      { key:"parte_corpo_outro", label:"PARTE DO CORPO (OUTRO) — DESCREVER", type:"text", placeholder:"Descreva a parte do corpo",
        showIf:(a)=>a.parte_corpo==="OUTRO", requiredIf:(a)=>a.parte_corpo==="OUTRO"
      },

      { key:"samu", label:"ATENDIMENTO SAMU?", type:"select", options:["SIM","NÃO"] },
      { key:"local_ocorrencia", label:"LOCAL OCORRÊNCIA (ENDEREÇO)", type:"text", placeholder:"Rua, número, bairro, referência…" },

      { key:"cid", label:"CID", type:"text", placeholder:"Ex.: S93.4" },
      { key:"cat", label:"CAT", type:"text", placeholder:"Número/identificação" },

      { key:"razao", label:"RAZÃO ACIDENTE", type:"select",
        options:["ATAQUE ANIMAL","FALTA DE ATENÇÃO","COLISÃO COM TERCEIRO","IMPRUDENCIAS","OUTRO"]
      },
      { key:"razao_outro", label:"RAZÃO (OUTRO) — DESCREVA", type:"text", placeholder:"Descreva a razão",
        showIf:(a)=>a.razao==="OUTRO", requiredIf:(a)=>a.razao==="OUTRO"
      },

      { key:"acao_preventiva", label:"AÇÃO PREVENTIVA", type:"select",
        options:["ORIENTAÇÃO FUNIONARIO","TREINAMENTO INDIVIDUAL","SUPERVISÃO CAMPO","REGISTRO EM ELATORIO","AFASTAMENTO COLABORADOR","OUTRO"]
      },
      { key:"acao_preventiva_outro", label:"AÇÃO PREVENTIVA (OUTRO) — DESCREVER", type:"text", placeholder:"Descreva a ação preventiva",
        showIf:(a)=>a.acao_preventiva==="OUTRO", requiredIf:(a)=>a.acao_preventiva==="OUTRO"
      },

      { key:"observacoes", label:"OBSERVAÇÕES (OPCIONAL)", type:"textarea", placeholder:"Detalhes adicionais..." },

      { key:"__review__", label:"REVISAR E ENVIAR", type:"review" }
    ];

    const answers = {};
    let cursor = 0;

    function isShown(step){
      if(typeof step.showIf === "function") return !!step.showIf(answers);
      return true;
    }
    function isRequired(step){
      if(step.required) return true;
      if(typeof step.requiredIf === "function") return !!step.requiredIf(answers);
      return false;
    }
    function currentStepIndex(){
      let i = cursor;
      while(i < steps.length && !isShown(steps[i])) i++;
      return i;
    }
    function prevVisibleIndex(from){
      let i = from - 1;
      while(i >= 0 && !isShown(steps[i])) i--;
      return i;
    }
    function nextVisibleIndex(from){
      let i = from + 1;
      while(i < steps.length && !isShown(steps[i])) i++;
      return i;
    }
    function shownCountUpTo(index){
      let count = 0;
      for(let i=0;i<=index;i++) if(isShown(steps[i])) count++;
      return count;
    }
    function totalShownCount(){
      let count = 0;
      for(const s of steps) if(isShown(s)) count++;
      return count;
    }

    function showBox(kind, msg){
      ["okBox","warnBox","errBox"].forEach(id=>{ $(id).style.display="none"; $(id).textContent=""; });
      const el = kind==="ok" ? $("okBox") : (kind==="warn" ? $("warnBox") : $("errBox"));
      el.textContent = msg;
      el.style.display = "block";
    }
    function clearBoxes(){
      ["okBox","warnBox","errBox"].forEach(id=>{ $(id).style.display="none"; $(id).textContent=""; });
    }

    function updateNet(){
      const online = navigator.onLine;
      $("netDot").className = "dot " + (online ? "ok" : "off");
      $("netText").textContent = online ? "Online" : "Offline";
    }
    window.addEventListener("online", ()=>{ updateNet(); flushQueue(); });
    window.addEventListener("offline", updateNet);
    updateNet();

    function getQueue(){
      try{ return JSON.parse(localStorage.getItem(QUEUE_KEY) || "[]"); }
      catch(e){ return []; }
    }
    function setQueue(q){
      localStorage.setItem(QUEUE_KEY, JSON.stringify(q));
      // badges removidos — nada aqui
    }

    function render(){
      clearBoxes();

      const i = currentStepIndex();
      cursor = i;

      const step = steps[i];
      const shownPos = shownCountUpTo(i);
      const total = totalShownCount();

      $("progressText").textContent = `Campo ${shownPos} de ${total}`;
      $("barFill").style.width = Math.round((shownPos/Math.max(1,total))*100) + "%";

      $("btnBack").disabled = prevVisibleIndex(i) < 0;
      $("btnOk").textContent = (step.type==="review") ? "Enviar" : "OK / Próximo";

      const req = isRequired(step);
      $("btnNA").disabled = req || step.type==="review";

      const area = $("stepArea");
      area.innerHTML = "";

      if(step.type === "review"){
        area.appendChild(renderReview());
        return;
      }

      const label = document.createElement("label");
      label.textContent = step.label;
      if(req){
        const star = document.createElement("span");
        star.className = "req";
        star.textContent = "*";
        label.appendChild(star);
      }
      area.appendChild(label);

      const hint = document.createElement("div");
      hint.className = "hint";
      hint.textContent = req ? "Obrigatório" : "Opcional (use N/A para pular)";
      area.appendChild(hint);

      const input = buildInput(step);
      area.appendChild(input);

      setTimeout(()=>{ try{ input.focus(); }catch(e){} }, 10);

      input.addEventListener("keydown", (ev)=>{
        if(ev.key === "Enter" && step.type !== "textarea"){
          ev.preventDefault();
          onOk();
        }
      });
    }

    function buildInput(step){
      const val = (answers[step.key] ?? "");
      let el;

      if(step.type === "select"){
        el = document.createElement("select");
        const opt0 = document.createElement("option");
        opt0.value = "";
        opt0.textContent = "Selecione…";
        el.appendChild(opt0);

        for(const o of step.options || []){
          const opt = document.createElement("option");
          opt.value = o;
          opt.textContent = o;
          el.appendChild(opt);
        }
        el.value = val;

      }else if(step.type === "textarea"){
        el = document.createElement("textarea");
        el.placeholder = step.placeholder || "";
        el.value = val;

      }else{
        el = document.createElement("input");
        el.type = step.type || "text";
        el.placeholder = step.placeholder || "";
        el.value = val;

        if(step.inputmode) el.setAttribute("inputmode", step.inputmode);
        if(step.type === "number"){
          el.min = "0";
          el.max = "120";
        }
      }

      el.id = "fieldInput";
      return el;
    }

    function readCurrentValue(){
      const input = $("fieldInput");
      if(!input) return "";
      let v = (input.value ?? "");
      if(typeof v === "string") v = v.trim();
      return v;
    }

    function validateStep(value){
      const step = steps[cursor];
      const req = isRequired(step);
      if(!req) return true;
      if(value === "" || value === "N/A"){
        showBox("err", "Este campo é obrigatório.");
        return false;
      }
      return true;
    }

    function prettyValue(v){
      if(v === undefined || v === null || v === "") return "—";
      return String(v);
    }

    function renderReview(){
      const wrap = document.createElement("div");
      wrap.className = "review";

      const h = document.createElement("h3");
      h.textContent = "Confira antes de enviar (toque para editar)";
      wrap.appendChild(h);

      const list = document.createElement("div");
      list.className = "list";

      for(let i=0;i<steps.length;i++){
        const s = steps[i];
        if(s.type === "review") continue;
        if(!isShown(s)) continue;

        const item = document.createElement("div");
        item.className = "item";

        const left = document.createElement("div");
        const b = document.createElement("b");
        b.textContent = s.label;
        const span = document.createElement("span");
        span.textContent = prettyValue(answers[s.key]);
        left.appendChild(b);
        left.appendChild(span);

        const right = document.createElement("small");
        right.textContent = (isRequired(s) ? "obrig." : "opcional");

        item.appendChild(left);
        item.appendChild(right);

        item.addEventListener("click", ()=>{
          cursor = i;
          render();
        });

        list.appendChild(item);
      }

      wrap.appendChild(list);
      return wrap;
    }

    function autoClearDependents(step){
      if(step.key === "regiao" && answers.regiao !== "OUTRO") answers.regiao_outro = "";
      if(step.key === "tipo_lesao" && answers.tipo_lesao !== "OUTROS") answers.tipo_lesao_outro = "";
      if(step.key === "parte_corpo" && answers.parte_corpo !== "OUTRO") answers.parte_corpo_outro = "";
      if(step.key === "razao" && answers.razao !== "OUTRO") answers.razao_outro = "";
      if(step.key === "acao_preventiva" && answers.acao_preventiva !== "OUTRO") answers.acao_preventiva_outro = "";
    }

    function onOk(){
      const step = steps[cursor];

      if(step.type === "review"){
        submitAll();
        return;
      }

      const v = readCurrentValue();
      if(!validateStep(v)) return;

      answers[step.key] = v;
      autoClearDependents(step);

      cursor = nextVisibleIndex(cursor);
      render();
    }

    function onNA(){
      const step = steps[cursor];
      if(isRequired(step) || step.type==="review") return;

      answers[step.key] = "N/A";
      autoClearDependents(step);

      cursor = nextVisibleIndex(cursor);
      render();
    }

    function onBack(){
      const p = prevVisibleIndex(cursor);
      if(p >= 0){
        cursor = p;
        render();
      }
    }

    $("btnOk").addEventListener("click", onOk);
    $("btnNA").addEventListener("click", onNA);
    $("btnBack").addEventListener("click", onBack);

    function buildPayload(){
      return {
        action: ACTION,
        client_time: new Date().toISOString(),
        client_tz: Intl.DateTimeFormat().resolvedOptions().timeZone || "",

        matricula: answers.matricula || "",
        nome_funcionario: answers.nome_funcionario || "",
        idade: answers.idade || "",
        funcao: answers.funcao || "",
        setor: answers.setor || "",
        data_acidente: answers.data_acidente || "",

        regiao: answers.regiao || "",
        regiao_outro: answers.regiao_outro || "",

        gravidade: answers.gravidade || "",
        periodo_evento: answers.periodo_evento || "",

        tipo_lesao: answers.tipo_lesao || "",
        tipo_lesao_outro: answers.tipo_lesao_outro || "",

        parte_corpo: answers.parte_corpo || "",
        parte_corpo_outro: answers.parte_corpo_outro || "",

        samu: answers.samu || "",
        local_ocorrencia: answers.local_ocorrencia || "",

        cid: answers.cid || "",
        cat: answers.cat || "",

        razao: answers.razao || "",
        razao_outro: answers.razao_outro || "",

        acao_preventiva: answers.acao_preventiva || "",
        acao_preventiva_outro: answers.acao_preventiva_outro || "",

        observacoes: answers.observacoes || ""
      };
    }

    async function postPayload(payload){
      const body = new URLSearchParams(payload);
      const res = await fetch(API_URL, {
        method:"POST",
        headers:{ "Content-Type":"application/x-www-form-urlencoded;charset=UTF-8" },
        body
      });
      const txt = await res.text();
      let json=null; try{ json=JSON.parse(txt);}catch(e){}
      if(!res.ok) throw new Error("HTTP "+res.status+" — "+(json?.message || txt || ""));
      if(json && json.ok===false) throw new Error(json.message || "Erro no servidor");
      return json || { ok:true, raw:txt };
    }

    async function flushQueue(){
      if(!navigator.onLine) return;
      const q = getQueue();
      if(q.length === 0) return;

      let sent = 0;
      while(q.length){
        const item = q[0];
        try{
          await postPayload(item.payload);
          q.shift();
          sent++;
          setQueue(q);
        }catch(e){
          if(sent>0) showBox("warn","Reenviados "+sent+" item(ns). Ainda restam "+q.length+" na fila.");
          return;
        }
      }
      if(sent>0) showBox("ok","Fila enviada com sucesso ("+sent+" item(ns)).");
    }

    async function submitAll(){
      clearBoxes();

      if(!answers.matricula || answers.matricula==="N/A"){
        cursor = steps.findIndex(s=>s.key==="matricula");
        render();
        showBox("err","Informe a matrícula (obrigatório).");
        return;
      }
      if(!answers.nome_funcionario || answers.nome_funcionario==="N/A"){
        cursor = steps.findIndex(s=>s.key==="nome_funcionario");
        render();
        showBox("err","Informe o nome (obrigatório).");
        return;
      }

      const payload = buildPayload();
      $("btnOk").disabled = true;
      $("btnNA").disabled = true;
      $("btnBack").disabled = true;

      try{
        if(navigator.onLine){
          await postPayload(payload);
          showBox("ok","Registro enviado com sucesso.");

          for(const k in answers) delete answers[k];
          cursor = 0;
          render();

          await flushQueue();
        }else{
          const q = getQueue();
          q.push({ payload });
          setQueue(q);
          showBox("warn","Sem internet. Registro salvo na fila e será enviado automaticamente.");

          for(const k in answers) delete answers[k];
          cursor = 0;
          render();
        }
      }catch(e){
        const q = getQueue();
        q.push({ payload });
        setQueue(q);
        showBox("warn","Falha ao enviar agora. Salvei na fila para reenviar automaticamente. Detalhe: "+(e.message||e));

        for(const k in answers) delete answers[k];
        cursor = 0;
        render();
      }finally{
        $("btnOk").disabled = false;
        $("btnNA").disabled = false;
        $("btnBack").disabled = false;
      }
    }

    cursor = 0;
    render();
    flushQueue();
  </script>
</body>
</html>
