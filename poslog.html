<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=no" />
  <title>PAVI Fast â€” PÃ³s-login</title>

  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#10b981">

  <style>
    /* ==========================================================
       FUNNEL SANS â€” LOCAL (.ttf)
    ========================================================== */
    @font-face{font-family:'FunnelSans';src:url('FunnelSans-Regular.ttf') format('truetype');font-weight:400;font-style:normal;font-display:swap;}
    @font-face{font-family:'FunnelSans';src:url('FunnelSans-Medium.ttf') format('truetype');font-weight:500;font-style:normal;font-display:swap;}
    @font-face{font-family:'FunnelSans';src:url('FunnelSans-SemiBold.ttf') format('truetype');font-weight:600;font-style:normal;font-display:swap;}
    @font-face{font-family:'FunnelSans';src:url('FunnelSans-Bold.ttf') format('truetype');font-weight:700;font-style:normal;font-display:swap;}

    html, body, * { font-family:'FunnelSans', system-ui, -apple-system, 'Segoe UI', Arial, sans-serif !important; }

    :root{
      --bg:#f8fdf9;
      --card:#ffffff;
      --text:#1a472a;
      --muted:#5d7a6d;
      --primary:#10b981;
      --primary-600:#0da271;
      --primary-700:#0b8c61;
      --border:#d1fae5;
      --shadow:0 15px 35px rgba(16,185,129,0.10), 0 5px 15px rgba(0,0,0,0.06);
      --warn-bg:#fff7ed; --warn:#9a3412; --warn-br:#fed7aa;
      --err-bg:#fef2f2; --err:#991b1b; --err-br:#fecaca;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      min-height:100vh;
      min-height:100dvh;
      padding-bottom:90px;
    }

    .topbar{
      position:sticky; top:0; z-index:10;
      background:rgba(248,253,249,.92);
      backdrop-filter: blur(10px);
      border-bottom:1px solid #e5f7ef;
      padding:10px 14px;
      display:flex; align-items:center; justify-content:space-between;
    }
    .brand b{ font-size:15px; font-weight:800; }
    .brand small{ font-size:12px; color:var(--muted); font-weight:700; }

    .pillUser{
      padding:8px 12px;
      border-radius:999px;
      border:2px solid var(--border);
      background:#fff;
      font-size:12px;
      font-weight:800;
      max-width:52vw;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }

    .wrap{ max-width:980px; margin:0 auto; padding:14px; }

    .panel{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:20px;
      box-shadow:var(--shadow);
      padding:16px;
    }

    .grid{
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap:12px;
    }
    @media (max-width:720px){
      .grid{ grid-template-columns: 1fr; }
    }

    .loteCard{
      border:1px solid var(--border);
      border-radius:18px;
      background:#fff;
      overflow:hidden;
    }

    .loteHead{
      padding:12px;
      background:#fbfffd;
      border-bottom:1px solid #e5f7ef;
      display:flex;
      justify-content:space-between;
      align-items:center;
    }

    .rodList{
      padding:12px;
      display:flex;
      flex-wrap:wrap;
      gap:8px;
    }

    .rodBtn{
      border:2px solid var(--border);
      background:#fbfffd;
      padding:10px 12px;
      border-radius:999px;
      cursor:pointer;
      font-weight:900;
      font-size:13px;
    }

    .rodBtn:hover{ background:#f0fdf9; }

    .msg{
      margin-top:12px;
      padding:12px;
      border-radius:14px;
      font-weight:900;
      display:none;
      font-size:13px;
      white-space:pre-line;
      line-height:1.35;
    }
    .msg.warn{ background:var(--warn-bg); color:var(--warn); border:2px solid var(--warn-br); }
    .msg.err{ background:var(--err-bg); color:var(--err); border:2px solid var(--err-br); }

    .actions{
      display:flex;
      gap:10px;
      margin-top:16px;
      flex-wrap:wrap;
    }

    .btn{
      flex:1;
      min-width:180px;
      padding:14px;
      border-radius:16px;
      border:none;
      cursor:pointer;
      font-weight:900;
      font-size:15px;
      background:linear-gradient(135deg, var(--primary), var(--primary-600));
      color:#fff;
    }

    .btn.secondary{
      background:#fff;
      color:var(--primary-700);
      border:2px solid var(--border);
    }
  </style>
</head>

<body>

<div class="topbar">
  <div class="brand">
    <b>PAVI Fast</b>
    <small>Escolha a rodovia</small>
  </div>
  <div class="pillUser" id="who">â€”</div>
</div>

<div class="wrap">
  <div class="panel">
    <div id="msg" class="msg"></div>
    <div id="grid" class="grid"></div>

    <div class="actions">
      <button class="btn secondary" id="btnLogout">Sair</button>
    </div>
  </div>
</div>

<script>
/* ==========================================================
   CONFIG
========================================================== */
const WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbzbUN-2Heaogs0140LZGJEctnNW85aTxHJmGPatf-rTn1Ze_JM6bCA_BsVRvMiYPwuLDA/exec';

const LS_SESSION_V1 = 'PAVI_FAST_SESSION_V1';
const LS_USER = 'PAVI_FAST_USER';
const LS_NAME = 'PAVI_FAST_NAME';

// ðŸ”‘ PADRÃƒO DO PROJETO
const LS_LOTE = 'PAVI_FAST_LOTE';
const LS_LOTE_SELECTED = 'PAVI_FAST_LOTE_SELECTED';
const LS_RODOVIA_PRE = 'PAVI_FAST_RODOVIA_PRESELECT';

const CACHE_LOTE_ROD = 'PAVI_FAST_LOTE_RODOVIAS_CACHE_V1';
const NEXT_PAGE = 'seletor_lotes.html';
const LOGIN_PAGE = 'index.html';

const $ = s => document.querySelector(s);

/* ==========================================================
   SessÃ£o
========================================================== */
function guardSession(){
  let sess = null;

  try{
    sess = JSON.parse(localStorage.getItem(LS_SESSION_V1));
  }catch{}

  if(sess && sess.usuario){
    return sess;
  }

  // ðŸ” retry para WebView (evita falso logout)
  setTimeout(()=>{
    let retry = null;
    try{
      retry = JSON.parse(localStorage.getItem(LS_SESSION_V1));
    }catch{}

    if(!retry || !retry.usuario){
      window.location.replace(LOGIN_PAGE);
    }
  }, 300);

  return null;
}

const sess = guardSession();
if(!sess) {
  // interrompe execuÃ§Ã£o atÃ© o retry
  throw new Error('Aguardando sessÃ£o estabilizar');
}

$('#who').textContent = sess.nome || sess.usuario;
const allowedLotes = Array.isArray(sess.lotes) ? sess.lotes : [];

/* ==========================================================
   Helpers
========================================================== */
function showMsg(text, type){
  const el = $('#msg');
  el.className = 'msg ' + type;
  el.textContent = text;
  el.style.display = 'block';
}

function hideMsg(){
  const el = $('#msg');
  el.style.display = 'none';
  el.textContent = '';
}

function saveCache(map){
  try{
    localStorage.setItem(CACHE_LOTE_ROD, JSON.stringify({ ts: Date.now(), map }));
  }catch{}
}

function loadCache(){
  try{
    const c = JSON.parse(localStorage.getItem(CACHE_LOTE_ROD));
    return c?.map || null;
  }catch{ return null; }
}

async function post(params){
  const body = new URLSearchParams(params);
  const r = await fetch(WEBAPP_URL, { method:'POST', body });
  const t = await r.text();
  const j = JSON.parse(t);
  if(j.status !== 'OK') throw new Error(j.mensagem || 'Erro');
  return j;
}

/* ==========================================================
   Render
========================================================== */
function render(map){
  const grid = $('#grid');
  grid.innerHTML = '';

  allowedLotes.forEach(lote=>{
    const rods = map?.[lote] || [];

    const card = document.createElement('div');
    card.className = 'loteCard';

    card.innerHTML = `
      <div class="loteHead"><b>${lote}</b></div>
      <div class="rodList"></div>
    `;

    const list = card.querySelector('.rodList');

    if(!rods.length){
      const empty = document.createElement('div');
      empty.style.padding = '10px 12px';
      empty.style.color = 'var(--muted)';
      empty.style.fontWeight = '900';
      empty.textContent = 'Sem rodovias neste lote.';
      list.appendChild(empty);
    }else{
      rods.forEach(r=>{
        const b = document.createElement('button');
        b.className = 'rodBtn';
        b.type = 'button';
        b.textContent = r;
        b.onclick = ()=>{
          localStorage.setItem(LS_LOTE, lote);
          localStorage.setItem(LS_LOTE_SELECTED, lote);
          localStorage.setItem(LS_RODOVIA_PRE, r);

          // ðŸ”’ garante flush do storage
          setTimeout(()=>{
            window.location.replace(NEXT_PAGE);
          }, 150);
        };
        list.appendChild(b);
      });
    }

    grid.appendChild(card);
  });
}

/* ==========================================================
   Init (OFFLINE OK: usa cache quando sem internet)
========================================================== */
(async ()=>{
  if(!allowedLotes.length){
    showMsg('Nenhum lote liberado para seu usuÃ¡rio.', 'err');
    return;
  }

  // 1) Renderiza cache primeiro (se existir) -> funciona offline
  const cached = loadCache();
  if(cached){
    render(cached);
    // mensagem leve (opcional)
    if(!navigator.onLine){
      showMsg('Modo offline: exibindo dados do cache.\n(Conecte 1x para atualizar.)', 'warn');
    }else{
      hideMsg();
    }
  }else{
    if(!navigator.onLine){
      showMsg('Offline e sem cache ainda.\nConecte-se 1 vez para carregar as rodovias.', 'warn');
      return;
    }
  }

  // 2) Se estiver online, tenta atualizar do servidor e sobrescreve cache
  if(!navigator.onLine) return;

  try{
    const j = await post({ action:'lote_rodovias', lotes: allowedLotes.join(',') });
    const map = j.lotes || {};
    render(map);
    saveCache(map);
    hideMsg();
  }catch{
    // se falhar online mas havia cache, mantÃ©m cache
    if(cached){
      showMsg('NÃ£o foi possÃ­vel atualizar agora.\nExibindo cache salvo.', 'warn');
    }else{
      showMsg('Falha ao carregar rodovias.\nConecte-se Ã  internet.', 'warn');
    }
  }
})();

/* ==========================================================
   Logout
========================================================== */
$('#btnLogout').onclick = ()=>{
  localStorage.clear();
  location.href = LOGIN_PAGE;
};
</script>

<!-- âœ… Service Worker: registro correto -->
<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./sw.js').catch(console.warn);
  });
}
</script>

</body>
</html>
