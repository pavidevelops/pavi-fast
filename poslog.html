<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=no" />
  <title>PAVI Fast — Pós-login</title>

  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#10b981">

  <style>
    /* ==========================================================
       FUNNEL SANS — LOCAL (.ttf)
    ========================================================== */
    @font-face{font-family:'FunnelSans';src:url('FunnelSans-Regular.ttf') format('truetype');font-weight:400;font-style:normal;font-display:swap;}
    @font-face{font-family:'FunnelSans';src:url('FunnelSans-Medium.ttf') format('truetype');font-weight:500;font-style:normal;font-display:swap;}
    @font-face{font-family:'FunnelSans';src:url('FunnelSans-SemiBold.ttf') format('truetype');font-weight:600;font-style:normal;font-display:swap;}
    @font-face{font-family:'FunnelSans';src:url('FunnelSans-Bold.ttf') format('truetype');font-weight:700;font-style:normal;font-display:swap;}

    html, body, * {
      font-family:'FunnelSans', system-ui, -apple-system, 'Segoe UI', Arial, sans-serif !important;
    }

    :root{
      --bg:#f8fdf9;
      --card:#ffffff;
      --text:#1a472a;
      --muted:#5d7a6d;
      --primary:#10b981;
      --primary-600:#0da271;
      --primary-700:#0b8c61;
      --border:#d1fae5;
      --shadow:0 15px 35px rgba(16,185,129,0.10), 0 5px 15px rgba(0,0,0,0.06);
      --warn-bg:#fff7ed; --warn:#9a3412; --warn-br:#fed7aa;
      --err-bg:#fef2f2; --err:#991b1b; --err-br:#fecaca;
    }

    *{ box-sizing:border-box; }

    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      min-height:100vh;
      min-height:100dvh;
      padding-bottom:90px;
    }

    .topbar{
      position:sticky; top:0; z-index:10;
      background:rgba(248,253,249,.92);
      backdrop-filter: blur(10px);
      border-bottom:1px solid #e5f7ef;
      padding:10px 14px;
      display:flex; align-items:center; justify-content:space-between;
    }
    .brand b{ font-size:15px; font-weight:900; }
    .brand small{ font-size:12px; color:var(--muted); font-weight:800; }
    .pillUser{
      padding:8px 12px;
      border-radius:999px;
      border:2px solid var(--border);
      background:#fff;
      font-size:12px;
      font-weight:900;
      max-width:55vw;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }

    .wrap{ max-width:980px; margin:0 auto; padding:14px; }
    .panel{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:20px;
      box-shadow:var(--shadow);
      padding:16px;
    }

    .grid{
      display:grid;
      grid-template-columns:repeat(2,minmax(0,1fr));
      gap:12px;
    }
    @media(max-width:720px){ .grid{grid-template-columns:1fr} }

    .loteCard{
      border:1px solid var(--border);
      border-radius:18px;
      background:#fff;
    }
    .loteHead{
      padding:12px;
      background:#fbfffd;
      border-bottom:1px solid #e5f7ef;
      display:flex; justify-content:space-between; gap:10px;
    }
    .loteTitle b{ font-weight:900; }
    .loteTitle small{ font-size:12px; color:var(--muted); font-weight:800; }

    .rodList{
      padding:12px;
      display:flex; flex-wrap:wrap; gap:8px;
    }
    .rodBtn{
      border:2px solid var(--border);
      background:#fbfffd;
      font-weight:900;
      padding:10px 12px;
      border-radius:999px;
      cursor:pointer;
      font-size:13px;
    }
    .rodBtn:hover{ background:#f0fdf9; }

    .msg{
      display:none;
      margin-top:12px;
      padding:12px;
      border-radius:14px;
      font-weight:900;
      font-size:13px;
    }
    .msg.warn{ background:var(--warn-bg); color:var(--warn); border:2px solid var(--warn-br); }
    .msg.err{ background:var(--err-bg); color:var(--err); border:2px solid var(--err-br); }

    .actions{ display:flex; gap:10px; margin-top:14px; flex-wrap:wrap; }
    .btn{
      flex:1; min-width:180px;
      padding:14px;
      border-radius:16px;
      border:none;
      font-weight:900;
      cursor:pointer;
    }
    .btn.primary{
      background:linear-gradient(135deg,var(--primary),var(--primary-600));
      color:#fff;
    }
    .btn.secondary{
      background:#fff;
      color:var(--primary-700);
      border:2px solid var(--border);
    }
  </style>
</head>

<body>

<div class="topbar">
  <div class="brand">
    <b>PAVI Fast</b>
    <small>Selecione a rodovia</small>
  </div>
  <div class="pillUser" id="who">—</div>
</div>

<div class="wrap">
  <div class="panel">
    <div class="msg warn" id="msg"></div>
    <div class="grid" id="grid"></div>

    <div class="actions">
      <button class="btn secondary" id="btnLogout">Sair</button>
      <button class="btn primary" id="btnNext" disabled>Continuar</button>
    </div>
  </div>
</div>

<script>
/* ==========================================================
   CONFIG / CHAVES PADRÃO DO PROJETO
========================================================== */
const LOGIN_PAGE = 'index.html';
const NEXT_PAGE  = 'seletor_lotes.html';

const LS_USER  = 'PAVI_FAST_USER';
const LS_NAME  = 'PAVI_FAST_NAME';
const LS_SESS  = 'PAVI_FAST_SESSION_V1';

const LS_LOTE  = 'PAVI_FAST_LOTE';
const LS_LOTE_SELECTED = 'PAVI_FAST_LOTE_SELECTED';
const LS_RODOVIA_PRE   = 'PAVI_FAST_RODOVIA_PRESELECT';

/* ==========================================================
   Sessão (guard)
========================================================== */
const sessRaw = localStorage.getItem(LS_SESS);
const user = localStorage.getItem(LS_USER);

if(!user && !sessRaw){
  location.replace(LOGIN_PAGE);
}

const sess = sessRaw ? JSON.parse(sessRaw) : {};
const nome = sess.nome || localStorage.getItem(LS_NAME) || user;

document.getElementById('who').textContent = nome || '—';

/* ==========================================================
   Dados simulados (já vêm do cache no projeto real)
========================================================== */
const allowedLotes = Array.isArray(sess.lotes) ? sess.lotes : [];
const fakeRodovias = {
  "L1": ["PR-082","PR-323"],
  "L2": ["PR-445"]
};

/* ==========================================================
   Render
========================================================== */
let selectedLote = '';
let selectedRodovia = '';

function setSelection(lote, rodovia){
  selectedLote = lote;
  selectedRodovia = rodovia;

  localStorage.setItem(LS_LOTE, lote);
  localStorage.setItem(LS_LOTE_SELECTED, lote);
  localStorage.setItem(LS_RODOVIA_PRE, rodovia);

  document.getElementById('btnNext').disabled = false;
}

function render(){
  const grid = document.getElementById('grid');
  grid.innerHTML = '';

  if(!allowedLotes.length){
    const m = document.getElementById('msg');
    m.textContent = 'Nenhum lote liberado para este usuário.';
    m.className = 'msg err';
    m.style.display = 'block';
    return;
  }

  allowedLotes.forEach(lote=>{
    const card = document.createElement('div');
    card.className = 'loteCard';

    card.innerHTML = `
      <div class="loteHead">
        <div class="loteTitle">
          <b>Lote ${lote}</b>
          <small>${lote}</small>
        </div>
      </div>
      <div class="rodList"></div>
    `;

    const list = card.querySelector('.rodList');
    (fakeRodovias[lote] || []).forEach(r=>{
      const b = document.createElement('button');
      b.className = 'rodBtn';
      b.textContent = r;
      b.onclick = ()=> setSelection(lote, r);
      list.appendChild(b);
    });

    grid.appendChild(card);
  });
}

render();

/* ==========================================================
   Botões
========================================================== */
document.getElementById('btnNext').onclick = ()=>{
  location.replace(NEXT_PAGE);
};

document.getElementById('btnLogout').onclick = ()=>{
  localStorage.clear();
  location.replace(LOGIN_PAGE);
};
</script>

<script>
if('serviceWorker' in navigator){
  navigator.serviceWorker.register('./sw.js').catch(()=>{});
}
</script>

</body>
</html>
