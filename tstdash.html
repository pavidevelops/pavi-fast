<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>PAVI FAST ‚Äî TST Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
@font-face{font-family:'FunnelSans';src:url('FunnelSans-Regular.ttf') format('truetype');font-weight:400}
@font-face{font-family:'FunnelSans';src:url('FunnelSans-Medium.ttf') format('truetype');font-weight:500}
@font-face{font-family:'FunnelSans';src:url('FunnelSans-Bold.ttf') format('truetype');font-weight:700}

*{box-sizing:border-box;margin:0;padding:0;font-family:'FunnelSans',Arial,sans-serif}

:root{
  --blue:#0f3d68;
  --blue-light:#1e5a96;
  --bg:#f5f7fa;
  --card:#fff;
  --border:#dbe3ec;
  --danger:#dc2626;
  --danger-light:#fee2e2;
  --warn:#fef3c7;
  --success:#059669;
  --gray:#6b7280;
  --shadow:0 4px 6px -1px rgba(0,0,0,0.1);
}

body{background:var(--bg);color:#1f2937}

/* HEADER */
header{
  height:64px;
  background:var(--blue);
  color:#fff;
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:0 24px;
  box-shadow:0 2px 4px rgba(0,0,0,0.1);
}

.logo{display:flex;align-items:center;gap:12px}
.logo h1{font-size:20px;font-weight:600}

.alert-bell{
  position:relative;
  cursor:pointer;
  font-size:20px;
  display:flex;
  align-items:center;
  gap:8px;
}
.notification-count{
  position:absolute;
  top:-8px;
  right:-8px;
  background:var(--danger);
  color:white;
  border-radius:50%;
  width:20px;
  height:20px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:12px;
  font-weight:700;
}

/* CONTAINER */
.container{
  max-width:1600px;
  margin:0 auto;
  padding:24px;
}

/* CARDS */
.card{
  background:var(--card);
  border-radius:12px;
  padding:24px;
  box-shadow:var(--shadow);
  margin-bottom:24px;
  border:1px solid var(--border);
}

/* FILTROS */
.filters{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
  gap:16px;
  margin-bottom:16px;
}

.filter-group{display:flex;flex-direction:column}
.filter-group label{
  font-size:14px;
  font-weight:500;
  margin-bottom:6px;
  color:var(--blue);
}

input,select{
  padding:12px;
  border-radius:8px;
  border:1px solid var(--border);
  font-size:14px;
  background:white;
}
input:focus,select:focus{
  outline:none;
  border-color:var(--blue-light);
  box-shadow:0 0 0 3px rgba(15,61,104,0.1);
}

/* CONTROLE DE FILTROS E GR√ÅFICOS */
.controls-container{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-top:16px;
  flex-wrap:wrap;
  gap:16px;
}

.chart-controls{
  display:flex;
  flex-wrap:wrap;
  gap:12px;
  align-items:center;
}

.chart-toggle{
  display:flex;
  align-items:center;
  gap:6px;
  cursor:pointer;
  padding:8px 12px;
  background:#f8fafc;
  border-radius:6px;
  border:1px solid var(--border);
  transition:all 0.2s;
  font-size:13px;
}
.chart-toggle:hover{background:#e5e7eb}
.chart-toggle.active{background:var(--blue);color:white}

.chart-checkbox{
  display:none;
}

/* BOT√ïES */
.button-group{
  display:flex;
  gap:12px;
  align-items:center;
}

button{
  padding:10px 20px;
  border:none;
  border-radius:8px;
  cursor:pointer;
  font-weight:500;
  font-size:14px;
  transition:all 0.2s;
  display:inline-flex;
  align-items:center;
  gap:6px;
}
button:hover{transform:translateY(-1px);box-shadow:var(--shadow)}
button:active{transform:translateY(0)}

.btn-primary{
  background:var(--blue);
  color:#fff;
}
.btn-primary:hover{background:var(--blue-light)}

.btn-secondary{
  background:#f3f4f6;
  color:#374151;
  border:1px solid var(--border);
}
.btn-secondary:hover{background:#e5e7eb}

.btn-danger{
  background:var(--danger-light);
  color:var(--danger);
  border:1px solid #fca5a5;
}
.btn-danger:hover{background:#fecaca}

.btn-small{
  padding:8px 12px;
  font-size:12px;
}

/* KPIs */
.kpis{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(240px,1fr));
  gap:20px;
  margin-bottom:24px;
}

.kpi-card{
  display:flex;
  flex-direction:column;
  align-items:center;
  text-align:center;
  padding:20px;
}

.kpi-value{
  font-size:32px;
  font-weight:700;
  margin:8px 0;
  color:var(--blue);
}

.kpi-label{
  font-size:14px;
  color:var(--gray);
  font-weight:500;
}

.kpi-icon{
  font-size:24px;
  margin-bottom:8px;
}

/* GR√ÅFICOS */
.charts{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(450px,1fr));
  gap:24px;
}

.chart-container{
  height:320px;
  position:relative;
}

/* TABELA */
.table-container{
  overflow-x:auto;
  margin-top:16px;
}

table{
  width:100%;
  border-collapse:collapse;
  font-size:14px;
}

th{
  background:#f1f5f9;
  color:var(--blue);
  font-weight:600;
  text-align:left;
  padding:16px 12px;
  border-bottom:2px solid var(--border);
}

td{
  padding:14px 12px;
  border-bottom:1px solid var(--border);
}

tr:hover{background:#f8fafc}

tr.pendente{
  background:var(--warn);
  border-left:4px solid #f59e0b;
}

.edit-btn{
  background:none;
  border:none;
  color:var(--blue);
  cursor:pointer;
  font-size:16px;
  padding:4px 8px;
  border-radius:4px;
  transition:all 0.2s;
}
.edit-btn:hover{
  background:#e0f2fe;
  transform:scale(1.1);
}

/* BADGES */
.badge{
  display:inline-block;
  padding:4px 10px;
  border-radius:12px;
  font-size:12px;
  font-weight:600;
}

.badge-danger{background:var(--danger-light);color:var(--danger)}
.badge-warning{background:#fef3c7;color:#92400e}
.badge-success{background:#d1fae5;color:var(--success)}
.badge-info{background:#dbeafe;color:var(--blue)}

/* MODAL */
.modal-bg{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.5);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:1000;
  backdrop-filter:blur(2px);
}

.modal{
  background:#fff;
  width:95%;
  max-width:900px;
  max-height:90vh;
  border-radius:16px;
  padding:32px;
  box-shadow:0 20px 25px -5px rgba(0,0,0,0.1);
  overflow-y:auto;
}

.modal-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:24px;
  padding-bottom:16px;
  border-bottom:1px solid var(--border);
}

.modal-header h2{
  color:var(--blue);
  font-size:24px;
  display:flex;
  align-items:center;
  gap:12px;
}

.close-modal{
  background:none;
  border:none;
  font-size:24px;
  color:var(--gray);
  cursor:pointer;
  padding:4px;
  border-radius:4px;
}
.close-modal:hover{background:#f3f4f6}

.modal-grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(250px,1fr));
  gap:16px;
}

.modal-field{
  display:flex;
  flex-direction:column;
}

.modal-field label{
  font-size:14px;
  font-weight:500;
  margin-bottom:6px;
  color:var(--blue);
  display:flex;
  align-items:center;
  justify-content:space-between;
}

.pendente-tag{
  font-size:11px;
  background:var(--danger-light);
  color:var(--danger);
  padding:2px 8px;
  border-radius:10px;
}

.modal-field input,.modal-field select,.modal-field textarea{
  padding:12px;
  border-radius:8px;
  border:1px solid var(--border);
  font-size:14px;
}

.modal-field textarea{
  min-height:80px;
  resize:vertical;
}

.field-pendente input,.field-pendente select,.field-pendente textarea{
  background:var(--warn);
  border-color:#f59e0b;
}

.modal-actions{
  display:flex;
  justify-content:flex-end;
  gap:16px;
  margin-top:32px;
  padding-top:24px;
  border-top:1px solid var(--border);
}

/* LOADING */
.loading{
  display:flex;
  justify-content:center;
  align-items:center;
  padding:40px;
  color:var(--gray);
  font-size:16px;
}

.empty-state{
  text-align:center;
  padding:48px 24px;
  color:var(--gray);
}
.empty-state i{font-size:48px;margin-bottom:16px;opacity:0.5}

/* RESPONSIVIDADE */
@media (max-width:1200px){
  .controls-container{
    flex-direction:column;
    align-items:stretch;
  }
  .chart-controls, .button-group{
    justify-content:center;
  }
}

@media (max-width:768px){
  .container{padding:16px}
  .charts{grid-template-columns:1fr}
  .modal-grid{grid-template-columns:1fr}
  .filters{grid-template-columns:1fr}
  header{padding:0 16px}
  .logo h1{font-size:16px}
  .controls-container{
    flex-direction:column;
    gap:12px;
  }
  .chart-controls{
    order:1;
  }
  .button-group{
    order:2;
    width:100%;
    justify-content:space-between;
  }
}
</style>
</head>

<body>

<header>
  <div class="logo">
    <h1>PAVI FAST ‚Äî Dashboard TST</h1>
  </div>
  <div class="alert-bell" id="alertBell" title="Pend√™ncias de dados">
    üîî <span class="notification-count" id="notificationCount">0</span>
  </div>
</header>

<div class="container">

<!-- FILTROS -->
<div class="card">
  <h2 style="margin-bottom:20px;color:var(--blue);">Filtros</h2>
  <div class="filters">
    <div class="filter-group">
      <label for="fDataInicio">Data Inicial</label>
      <input type="date" id="fDataInicio">
    </div>
    <div class="filter-group">
      <label for="fDataFim">Data Final</label>
      <input type="date" id="fDataFim">
    </div>
    <div class="filter-group">
      <label for="fSetor">Setor</label>
      <select id="fSetor">
        <option value="">Todos os setores</option>
      </select>
    </div>
    <div class="filter-group">
      <label for="fGrav">Gravidade</label>
      <select id="fGrav">
        <option value="">Todas as gravidades</option>
      </select>
    </div>
    <div class="filter-group">
      <label for="fPeriodo">Per√≠odo</label>
      <select id="fPeriodo">
        <option value="">Todos os per√≠odos</option>
      </select>
    </div>
  </div>
  
  <!-- CONTROLE DE FILTROS E GR√ÅFICOS -->
  <div class="controls-container">
    <div class="chart-controls">
      <div class="chart-toggle active" data-chart="cPeriodo">
        <input type="checkbox" class="chart-checkbox" id="togglePeriodo" checked>
        üìÖ Per√≠odo
      </div>
      <div class="chart-toggle active" data-chart="cGrav">
        <input type="checkbox" class="chart-checkbox" id="toggleGrav" checked>
        ‚ö†Ô∏è Gravidade
      </div>
      <div class="chart-toggle active" data-chart="cIdade">
        <input type="checkbox" class="chart-checkbox" id="toggleIdade" checked>
        üë• Idade
      </div>
      <div class="chart-toggle active" data-chart="cSetor">
        <input type="checkbox" class="chart-checkbox" id="toggleSetor" checked>
        üè≠ Setor
      </div>
    </div>
    
    <div class="button-group">
      <button class="btn-secondary" onclick="limparFiltros()">
        <span>‚Üª</span> Limpar Filtros
      </button>
      <button class="btn-primary" onclick="aplicarFiltros()">
        <span>üîç</span> Buscar
      </button>
    </div>
  </div>
</div>

<!-- KPIs -->
<div class="kpis">
  <div class="kpi-card">
    <div class="kpi-icon">üìä</div>
    <div class="kpi-value" id="kReg">0</div>
    <div class="kpi-label">Registros Filtrados</div>
  </div>
  <div class="kpi-card">
    <div class="kpi-icon">‚ö†Ô∏è</div>
    <div class="kpi-value" id="kPend">0</div>
    <div class="kpi-label">Pend√™ncias de Dados</div>
  </div>
  <div class="kpi-card">
    <div class="kpi-icon">üìÖ</div>
    <div class="kpi-value" id="kDataMedia">-</div>
    <div class="kpi-label">M√©dia de Idade</div>
  </div>
  <div class="kpi-card">
    <div class="kpi-icon">‚ö°</div>
    <div class="kpi-value" id="kGraves">0</div>
    <div class="kpi-label">Acidentes Graves/Fatais</div>
  </div>
</div>

<!-- GR√ÅFICOS -->
<div class="charts">
  <div class="card" id="chartPeriodoContainer">
    <h3 style="margin-bottom:16px;color:var(--blue);font-size:18px;">Per√≠odo do Dia</h3>
    <div class="chart-container">
      <canvas id="cPeriodo"></canvas>
    </div>
  </div>
  
  <div class="card" id="chartGravContainer">
    <h3 style="margin-bottom:16px;color:var(--blue);font-size:18px;">Gravidade do Acidente</h3>
    <div class="chart-container">
      <canvas id="cGrav"></canvas>
    </div>
  </div>
  
  <div class="card" id="chartIdadeContainer">
    <h3 style="margin-bottom:16px;color:var(--blue);font-size:18px;">Faixa Et√°ria</h3>
    <div class="chart-container">
      <canvas id="cIdade"></canvas>
    </div>
  </div>
  
  <div class="card" id="chartSetorContainer">
    <h3 style="margin-bottom:16px;color:var(--blue);font-size:18px;">Setor</h3>
    <div class="chart-container">
      <canvas id="cSetor"></canvas>
    </div>
  </div>
</div>

<!-- TABELA -->
<div class="card">
  <h2 style="margin-bottom:20px;color:var(--blue);">Registros de Acidentes</h2>
  <div class="loading" id="loadingTable">Carregando dados...</div>
  <div class="table-container" id="tableContainer" style="display:none;">
    <table>
      <thead>
        <tr>
          <th>Data</th>
          <th>Nome</th>
          <th>Idade</th>
          <th>Setor</th>
          <th>Gravidade</th>
          <th>Per√≠odo</th>
          <th>Status</th>
          <th>A√ß√£o</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>
  <div class="empty-state" id="emptyTable" style="display:none;">
    <div>üìä</div>
    <p>Nenhum registro encontrado com os filtros aplicados.</p>
  </div>
</div>

</div>

<!-- MODAL DE EDI√á√ÉO -->
<div class="modal-bg" id="modalBg">
  <div class="modal">
    <div class="modal-header">
      <h2><span>‚úèÔ∏è</span> Editar Registro</h2>
      <button class="close-modal" onclick="fecharModal()">√ó</button>
    </div>
    <div class="modal-grid" id="modalForm"></div>
    <div class="modal-actions">
      <button class="btn-secondary" onclick="fecharModal()">Cancelar</button>
      <button class="btn-danger" onclick="marcarComoPendente()" id="btnPendente">
        <span>‚ö†Ô∏è</span> Marcar como Pendente
      </button>
      <button class="btn-primary" onclick="salvarEdicao()">
        <span>üíæ</span> Salvar Altera√ß√µes
      </button>
    </div>
  </div>
</div>

<script>
const SHEET_ID = "1Y3hVIfe1YQXgl8VgJEXvJ3VKdWvLZ6IXzPCNQxtJK2U";
const CSV = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=0&t=${Date.now()}`;

let raw = [], filtered = [], charts = {}, editIndex = null;
const CAMPOS_OBRIGATORIOS = ['DATA_RECEBIMENTO', 'NOME', 'IDADE', 'SETOR', 'GRAVIDADE', 'PERIODO'];

// Inicializa√ß√£o
document.addEventListener('DOMContentLoaded', function() {
  configurarDatasPadrao();
  carregarDados();
  configurarEventos();
});

function configurarDatasPadrao() {
  const hoje = new Date();
  const trintaDiasAtras = new Date();
  trintaDiasAtras.setDate(hoje.getDate() - 30);
  
  fDataInicio.valueAsDate = trintaDiasAtras;
  fDataFim.valueAsDate = hoje;
}

function configurarEventos() {
  // Toggle dos gr√°ficos
  document.querySelectorAll('.chart-toggle').forEach(toggle => {
    toggle.addEventListener('click', function() {
      const chartId = this.dataset.chart;
      const checkbox = this.querySelector('.chart-checkbox');
      const chartContainer = document.getElementById(`chart${chartId.charAt(1).toUpperCase() + chartId.slice(1)}Container`);
      
      checkbox.checked = !checkbox.checked;
      this.classList.toggle('active', checkbox.checked);
      chartContainer.style.display = checkbox.checked ? 'block' : 'none';
    });
  });
  
  // Buscar com Enter
  [fDataInicio, fDataFim, fSetor, fGrav, fPeriodo].forEach(input => {
    input.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') aplicarFiltros();
    });
  });
}

function carregarDados() {
  Papa.parse(CSV, {
    download: true,
    header: true,
    skipEmptyLines: true,
    complete: function(result) {
      raw = result.data.map((item, index) => {
        // Adicionar ID √∫nico se n√£o existir
        if (!item.CLIENT_UID) item.CLIENT_UID = `TST_${Date.now()}_${index}`;
        
        // Verificar pend√™ncias
        const camposVazios = CAMPOS_OBRIGATORIOS.filter(campo => {
          return !item[campo] || item[campo].toString().trim() === '';
        });
        
        item.PENDENCIAS = camposVazios.length;
        item.TEM_PENDENCIAS = camposVazios.length > 0;
        item.CAMPOS_VAZIOS = camposVazios;
        
        return item;
      });
      
      preencherFiltros();
      aplicarFiltros();
    },
    error: function(error) {
      console.error('Erro ao carregar dados:', error);
      // Simular dados para demonstra√ß√£o
      simularDados();
    }
  });
}

function preencherFiltros() {
  preencherSelect('fSetor', 'SETOR');
  preencherSelect('fGrav', 'GRAVIDADE');
  preencherSelect('fPeriodo', 'PERIODO');
}

function preencherSelect(selectId, coluna) {
  const select = document.getElementById(selectId);
  const valores = [...new Set(raw.map(item => item[coluna]).filter(Boolean))].sort();
  
  valores.forEach(valor => {
    select.innerHTML += `<option value="${valor}">${valor}</option>`;
  });
}

function limparFiltros() {
  fDataInicio.value = '';
  fDataFim.value = '';
  fSetor.value = '';
  fGrav.value = '';
  fPeriodo.value = '';
  
  aplicarFiltros();
}

function aplicarFiltros() {
  loadingTable.style.display = 'flex';
  tableContainer.style.display = 'none';
  emptyTable.style.display = 'none';
  
  // Aplicar filtros
  filtered = raw.filter(item => {
    // Filtro por data
    if (fDataInicio.value) {
      const dataItem = new Date(item.DATA_RECEBIMENTO || 0);
      const dataInicio = new Date(fDataInicio.value);
      if (dataItem < dataInicio) return false;
    }
    
    if (fDataFim.value) {
      const dataItem = new Date(item.DATA_RECEBIMENTO || 0);
      const dataFim = new Date(fDataFim.value);
      dataFim.setHours(23, 59, 59);
      if (dataItem > dataFim) return false;
    }
    
    // Filtro por setor
    if (fSetor.value && item.SETOR !== fSetor.value) return false;
    
    // Filtro por gravidade
    if (fGrav.value && item.GRAVIDADE !== fGrav.value) return false;
    
    // Filtro por per√≠odo
    if (fPeriodo.value && item.PERIODO !== fPeriodo.value) return false;
    
    return true;
  });
  
  // Atualizar interface
  setTimeout(() => {
    atualizarKPIs();
    atualizarTabela();
    atualizarGraficos();
    loadingTable.style.display = 'none';
    
    if (filtered.length === 0) {
      emptyTable.style.display = 'block';
    } else {
      tableContainer.style.display = 'block';
    }
  }, 300);
}

function atualizarKPIs() {
  // Registros filtrados
  kReg.textContent = filtered.length;
  
  // Pend√™ncias
  const pendentes = filtered.filter(item => item.TEM_PENDENCIAS).length;
  kPend.textContent = pendentes;
  notificationCount.textContent = pendentes;
  
  // M√©dia de idade
  const idades = filtered
    .filter(item => item.IDADE && !isNaN(item.IDADE))
    .map(item => parseInt(item.IDADE));
  
  const mediaIdade = idades.length > 0 
    ? (idades.reduce((a, b) => a + b, 0) / idades.length).toFixed(1)
    : '-';
  kDataMedia.textContent = mediaIdade;
  
  // Acidentes graves/fatais
  const graves = filtered.filter(item => 
    item.GRAVIDADE === 'Grave' || item.GRAVIDADE === 'Fatal'
  ).length;
  kGraves.textContent = graves;
}

function atualizarTabela() {
  tbody.innerHTML = '';
  
  filtered.forEach((item, index) => {
    const pendente = item.TEM_PENDENCIAS;
    
    // Badge de gravidade
    let gravidadeBadge = item.GRAVIDADE || 'N/A';
    if (item.GRAVIDADE === 'Grave') {
      gravidadeBadge = '<span class="badge badge-danger">Grave</span>';
    } else if (item.GRAVIDADE === 'Fatal') {
      gravidadeBadge = '<span class="badge badge-danger">Fatal</span>';
    } else if (item.GRAVIDADE === 'Moderado') {
      gravidadeBadge = '<span class="badge badge-warning">Moderado</span>';
    } else if (item.GRAVIDADE === 'Leve') {
      gravidadeBadge = '<span class="badge badge-success">Leve</span>';
    }
    
    // Badge de status
    const statusBadge = pendente 
      ? `<span class="badge badge-warning">${item.PENDENCIAS} pend√™ncia(s)</span>`
      : `<span class="badge badge-success">Completo</span>`;
    
    const row = `
      <tr class="${pendente ? 'pendente' : ''}">
        <td>${formatarData(item.DATA_RECEBIMENTO)}</td>
        <td>${item.NOME || 'N/A'}</td>
        <td>${item.IDADE || 'N/A'}</td>
        <td>${item.SETOR || 'N/A'}</td>
        <td>${gravidadeBadge}</td>
        <td>${item.PERIODO || 'N/A'}</td>
        <td>${statusBadge}</td>
        <td>
          <button class="edit-btn" onclick="editarRegistro(${index})" title="Editar registro">
            ‚úèÔ∏è
          </button>
        </td>
      </tr>
    `;
    
    tbody.innerHTML += row;
  });
}

function formatarData(dataString) {
  if (!dataString) return 'N/A';
  
  try {
    const data = new Date(dataString);
    if (isNaN(data.getTime())) return dataString;
    
    return data.toLocaleDateString('pt-BR');
  } catch {
    return dataString;
  }
}

function atualizarGraficos() {
  // Destruir gr√°ficos existentes
  Object.values(charts).forEach(chart => {
    if (chart) chart.destroy();
  });
  
  // Dados para gr√°ficos
  const dadosPeriodo = agruparDados('PERIODO');
  const dadosGravidade = agruparDados('GRAVIDADE');
  const dadosFaixaEtaria = agruparPorFaixaEtaria();
  const dadosSetor = agruparDados('SETOR');
  
  // Cores para gr√°ficos
  const cores = ['#0f3d68', '#1e5a96', '#3b82f6', '#60a5fa', '#93c5fd'];
  
  // Gr√°fico de Per√≠odo
  if (togglePeriodo.checked) {
    const ctx = document.getElementById('cPeriodo').getContext('2d');
    charts.cPeriodo = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: Object.keys(dadosPeriodo),
        datasets: [{
          label: 'Quantidade',
          data: Object.values(dadosPeriodo),
          backgroundColor: cores[0],
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          title: { display: false }
        }
      }
    });
  }
  
  // Gr√°fico de Gravidade
  if (toggleGrav.checked) {
    const ctx = document.getElementById('cGrav').getContext('2d');
    charts.cGrav = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: Object.keys(dadosGravidade),
        datasets: [{
          label: 'Quantidade',
          data: Object.values(dadosGravidade),
          backgroundColor: cores[1],
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          title: { display: false }
        }
      }
    });
  }
  
  // Gr√°fico de Faixa Et√°ria
  if (toggleIdade.checked) {
    const ctx = document.getElementById('cIdade').getContext('2d');
    charts.cIdade = new Chart(ctx, {
      type: 'line',
      data: {
        labels: Object.keys(dadosFaixaEtaria),
        datasets: [{
          label: 'Quantidade',
          data: Object.values(dadosFaixaEtaria),
          backgroundColor: 'rgba(15, 61, 104, 0.1)',
          borderColor: cores[0],
          borderWidth: 2,
          fill: true,
          tension: 0.4
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          title: { display: false }
        }
      }
    });
  }
  
  // Gr√°fico de Setor
  if (toggleSetor.checked) {
    const ctx = document.getElementById('cSetor').getContext('2d');
    charts.cSetor = new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: Object.keys(dadosSetor),
        datasets: [{
          data: Object.values(dadosSetor),
          backgroundColor: cores.slice(0, Object.keys(dadosSetor).length),
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'bottom',
            labels: { font: { size: 11 } }
          },
          title: { display: false }
        }
      }
    });
  }
}

function agruparDados(coluna) {
  const resultado = {};
  
  filtered.forEach(item => {
    const valor = item[coluna] || 'N√£o Informado';
    resultado[valor] = (resultado[valor] || 0) + 1;
  });
  
  return resultado;
}

function agruparPorFaixaEtaria() {
  const faixas = {
    '18-25': 0,
    '26-35': 0,
    '36-45': 0,
    '46-55': 0,
    '56+': 0
  };
  
  filtered.forEach(item => {
    const idade = parseInt(item.IDADE);
    if (!isNaN(idade)) {
      if (idade <= 25) faixas['18-25']++;
      else if (idade <= 35) faixas['26-35']++;
      else if (idade <= 45) faixas['36-45']++;
      else if (idade <= 55) faixas['46-55']++;
      else faixas['56+']++;
    }
  });
  
  return faixas;
}

function editarRegistro(index) {
  editIndex = index;
  const registro = filtered[index];
  
  modalForm.innerHTML = '';
  
  // Criar campos para edi√ß√£o
  Object.entries(registro).forEach(([chave, valor]) => {
    if (chave === 'CLIENT_UID' || chave === 'PENDENCIAS' || chave === 'TEM_PENDENCIAS' || chave === 'CAMPOS_VAZIOS') {
      return;
    }
    
    const isPendente = CAMPOS_OBRIGATORIOS.includes(chave) && (!valor || valor.toString().trim() === '');
    const label = chave.replace(/_/g, ' ');
    
    let campoHTML = '';
    
    if (chave === 'DESCRICAO' || chave === 'ACOES_CORRETIVAS') {
      campoHTML = `
        <div class="modal-field ${isPendente ? 'field-pendente' : ''}">
          <label>
            ${label}
            ${isPendente ? '<span class="pendente-tag">PENDENTE</span>' : ''}
          </label>
          <textarea id="edit_${chave}" data-key="${chave}">${valor || ''}</textarea>
        </div>
      `;
    } else {
      campoHTML = `
        <div class="modal-field ${isPendente ? 'field-pendente' : ''}">
          <label>
            ${label}
            ${isPendente ? '<span class="pendente-tag">PENDENTE</span>' : ''}
          </label>
          <input type="text" id="edit_${chave}" value="${valor || ''}" data-key="${chave}">
        </div>
      `;
    }
    
    modalForm.innerHTML += campoHTML;
  });
  
  modalBg.style.display = 'flex';
}

function fecharModal() {
  modalBg.style.display = 'none';
  editIndex = null;
}

function salvarEdicao() {
  const registro = filtered[editIndex];
  
  // Atualizar valores
  document.querySelectorAll('#modalForm input, #modalForm textarea, #modalForm select').forEach(campo => {
    const chave = campo.dataset.key;
    registro[chave] = campo.value.trim();
  });
  
  // Recalcular pend√™ncias
  const camposVazios = CAMPOS_OBRIGATORIOS.filter(campo => {
    return !registro[campo] || registro[campo].toString().trim() === '';
  });
  
  registro.PENDENCIAS = camposVazios.length;
  registro.TEM_PENDENCIAS = camposVazios.length > 0;
  registro.CAMPOS_VAZIOS = camposVazios;
  
  // Atualizar tamb√©m nos dados completos
  const completoIndex = raw.findIndex(item => item.CLIENT_UID === registro.CLIENT_UID);
  if (completoIndex !== -1) {
    raw[completoIndex] = { ...registro };
  }
  
  // Atualizar interface
  atualizarTabela();
  atualizarKPIs();
  atualizarGraficos();
  
  fecharModal();
  
  alert('Registro atualizado! Em produ√ß√£o, as altera√ß√µes seriam salvas no Google Sheets via Apps Script.');
}

function marcarComoPendente() {
  if (editIndex === null) return;
  
  const registro = filtered[editIndex];
  
  // Marcar campos obrigat√≥rios como vazios
  CAMPOS_OBRIGATORIOS.forEach(campo => {
    if (!registro[campo] || registro[campo].toString().trim() === '') {
      const campoInput = document.getElementById(`edit_${campo}`);
      if (campoInput) {
        campoInput.value = '';
        campoInput.parentElement.classList.add('field-pendente');
      }
    }
  });
  
  // Atualizar pend√™ncias no modal
  const pendenteTags = document.querySelectorAll('.pendente-tag');
  pendenteTags.forEach(tag => {
    const label = tag.parentElement;
    if (!label.querySelector('.pendente-tag')) {
      label.innerHTML += ' <span class="pendente-tag">PENDENTE</span>';
    }
  });
}

function simularDados() {
  const setores = ['Produ√ß√£o', 'Manuten√ß√£o', 'Administrativo', 'Log√≠stica', 'Qualidade'];
  const gravidades = ['Leve', 'Moderado', 'Grave', 'Fatal'];
  const periodos = ['Manh√£', 'Tarde', 'Noite'];
  const nomes = ['Jo√£o Silva', 'Maria Santos', 'Pedro Oliveira', 'Ana Costa', 'Carlos Pereira'];
  
  const dadosSimulados = [];
  const hoje = new Date();
  
  for (let i = 0; i < 30; i++) {
    const data = new Date();
    data.setDate(hoje.getDate() - Math.floor(Math.random() * 90));
    
    const temPendencias = Math.random() > 0.7;
    
    dadosSimulados.push({
      CLIENT_UID: `TST_${Date.now()}_${i}`,
      DATA_RECEBIMENTO: data.toISOString().split('T')[0],
      NOME: temPendencias && Math.random() > 0.5 ? '' : nomes[Math.floor(Math.random() * nomes.length)],
      IDADE: temPendencias && Math.random() > 0.5 ? '' : (20 + Math.floor(Math.random() * 40)).toString(),
      SETOR: setores[Math.floor(Math.random() * setores.length)],
      GRAVIDADE: gravidades[Math.floor(Math.random() * gravidades.length)],
      PERIODO: periodos[Math.floor(Math.random() * periodos.length)],
      DESCRICAO: temPendencias && Math.random() > 0.5 ? '' : `Descri√ß√£o do acidente ${i+1}`,
      ACOES_CORRETIVAS: temPendencias && Math.random() > 0.5 ? '' : `A√ß√µes corretivas aplicadas`,
      LOCAL: '√Årea de Produ√ß√£o',
      TURNO: Math.random() > 0.5 ? 'Diurno' : 'Noturno',
      PENDENCIAS: temPendencias ? Math.floor(Math.random() * 3) + 1 : 0,
      TEM_PENDENCIAS: temPendencias,
      CAMPOS_VAZIOS: temPendencias ? ['NOME', 'DESCRICAO'].slice(0, Math.floor(Math.random() * 2) + 1) : []
    });
  }
  
  raw = dadosSimulados;
  preencherFiltros();
  aplicarFiltros();
}
</script>
</body>
</html>
