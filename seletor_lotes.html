<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PAVI Fast</title>
  <style>
    :root{
      --bg:#f8fdf9;
      --card:#ffffff;
      --text:#1a472a;
      --muted:#5d7a6d;
      --primary:#10b981;
      --primary-600:#0da271;
      --primary-700:#0b8c61;
      --border:#d1fae5;
      --shadow:0 15px 35px rgba(16,185,129,0.10), 0 5px 15px rgba(0,0,0,0.06);
      --ok-bg:#ecfdf5; --ok:#065f46; --ok-br:#a7f3d0;
      --err-bg:#fef2f2; --err:#991b1b; --err-br:#fecaca;
      --warn-bg:#fff7ed; --warn:#9a3412; --warn-br:#fed7aa;
      --radius:18px;
    }
    *{ box-sizing:border-box; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    body{
      margin:0; background:var(--bg); color:var(--text);
      min-height:100vh;
    }

    .topbar{
      position:sticky; top:0; z-index:10;
      background:rgba(248,253,249,.92);
      backdrop-filter: blur(10px);
      border-bottom:1px solid #e5f7ef;
      display:flex; align-items:center; gap:10px;
      padding:10px 12px;
    }
    .iconBtn{
      width:44px; height:44px;
      border-radius:14px;
      border:2px solid var(--border);
      background:#fff;
      cursor:pointer;
      display:flex; align-items:center; justify-content:center;
      font-size:18px;
    }
    .tblock{ display:flex; flex-direction:column; line-height:1.1; }
    .title{ font-weight:800; font-size:15px; }
    .badge{ font-size:12px; color:var(--muted); margin-top:4px; }

    .wrap{ max-width:980px; margin:0 auto; padding:14px; }
    .panel{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:20px;
      box-shadow:var(--shadow);
      padding:16px;
    }
    .row{ display:flex; gap:10px; flex-wrap:wrap; }
    .row > *{ flex:1; min-width:160px; }
    label{ display:block; font-size:13px; color:var(--muted); margin:10px 0 6px; font-weight:700; }
    input, select, button{
      width:100%;
      padding:14px 14px;
      border-radius:14px;
      border:2px solid var(--border);
      outline:none;
      background:#f8fdf9;
      color:var(--text);
      font-size:15px;
    }
    input:focus, select:focus{
      border-color: rgba(16,185,129,.55);
      box-shadow:0 0 0 4px rgba(16,185,129,.14);
      background:#fff;
    }
    .btn{
      border:none;
      background:linear-gradient(135deg, var(--primary), var(--primary-600));
      color:#fff;
      font-weight:800;
      cursor:pointer;
      box-shadow:0 10px 25px rgba(16,185,129,0.25);
      transition:.2s ease;
    }
    .btn:hover{ background:linear-gradient(135deg, var(--primary-600), var(--primary-700)); transform:translateY(-1px); }
    .btn:disabled{ opacity:.65; cursor:not-allowed; transform:none; box-shadow:none; }
    .btn.secondary{
      background:#fff;
      color:var(--primary-700);
      border:2px solid var(--border);
      box-shadow:none;
    }
    .btn.danger{
      background:#dc2626;
      box-shadow:0 10px 25px rgba(220,38,38,0.18);
    }

    .sep{ height:1px; background:#e5f7ef; margin:14px 0; }

    .kpis{ display:flex; gap:10px; flex-wrap:wrap; }
    .kpi{
      flex:1; min-width:180px;
      background:#fbfffd;
      border:1px solid var(--border);
      border-radius:18px;
      padding:12px 12px;
    }
    .kpi small{ display:block; color:var(--muted); font-weight:700; }
    .kpi b{ font-size:18px; }

    .hint{ font-size:12px; color:var(--muted); margin-top:6px; font-style:italic; }
    .hint a{ color:var(--primary-700); font-weight:800; }

    .pill{
      display:inline-flex; align-items:center; gap:6px;
      padding:6px 10px; border-radius:999px;
      font-size:12px; font-weight:800;
      border:2px solid var(--border);
      background:#fbfffd;
      white-space:nowrap;
    }
    .pill.ok{ background:var(--ok-bg); color:var(--ok); border-color:var(--ok-br); }
    .pill.err{ background:var(--err-bg); color:var(--err); border-color:var(--err-br); }
    .pill.warn{ background:var(--warn-bg); color:var(--warn); border-color:var(--warn-br); }

    .list{ display:flex; flex-direction:column; gap:10px; }
    .item{
      border:1px solid var(--border);
      border-radius:18px;
      padding:12px;
      background:#fff;
    }
    .itemTop{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .meta{ font-size:12px; color:var(--muted); margin-top:6px; }
    .actions{ display:flex; gap:10px; margin-top:10px; }
    .actions button{ padding:12px; border-radius:14px; }

    /* Drawer */
    .backdrop{
      position:fixed; inset:0; background:rgba(26,71,42,.35);
      display:none; z-index:20;
    }
    .drawer{
      position:fixed; top:0; left:0; height:100vh; width:280px;
      background:#fff;
      border-right:1px solid var(--border);
      box-shadow:var(--shadow);
      transform:translateX(-100%);
      transition:.2s ease;
      z-index:21;
      padding:10px;
    }
    .drawer.open{ transform:translateX(0); }
    .backdrop.open{ display:block; }
    .drawerHeader{
      padding:6px 8px 10px;
      border-bottom:1px solid #e5f7ef;
      margin-bottom:10px;
    }
    .drawerHeader b{ display:block; }
    .drawerHeader small{ color:var(--muted); font-weight:700; }
    .nav a{
      display:block;
      padding:12px 10px;
      border-radius:12px;
      color:var(--text);
      text-decoration:none;
      font-weight:800;
    }
    .nav a:hover{ background:#f0fdf9; }
    .nav a.danger{ color:#dc2626; }

    /* Views */
    .view{ display:none; }
    .view.active{ display:block; }

    /* Mobile tweak */
    @media (max-width:520px){
      .wrap{ padding:10px; }
      .row > *{ min-width:140px; }
    }
  </style>
</head>
<body>

  <div class="backdrop" id="backdrop"></div>
  <div class="drawer" id="drawer">
    <div class="drawerHeader">
      <b>PAVI Fast</b>
      <small id="who">‚Äî</small>
    </div>
    <div class="nav">
      <a href="#" data-nav="novo">‚ûï Novo registro</a>
      <a href="#" data-nav="meus">üóÇÔ∏è Meus envios</a>
      <a href="#" data-nav="sync">üîÑ Reenviar pendentes</a>
      <a href="#" data-nav="logout" class="danger">Sair</a>
    </div>
    <div class="sep"></div>
    <div class="hint">
      Cat√°logo de atividades: atualiza quando houver internet.<br>
      Offline: salva pendentes e reenvia depois.
    </div>
  </div>

  <div class="topbar">
    <button class="iconBtn" id="btnMenu" aria-label="Menu">‚ò∞</button>
    <div class="tblock">
      <div class="title" id="viewTitle">Novo registro</div>
      <div class="badge" id="netBadge">‚Äî</div>
    </div>
  </div>

  <div class="wrap">

    <div class="panel">
      <div class="kpis">
        <div class="kpi">
          <small>Usu√°rio</small>
          <b id="kUser">‚Äî</b>
        </div>
        <div class="kpi">
          <small>Atividades no cache</small>
          <b id="kAct">‚Äî</b>
        </div>
        <div class="kpi">
          <small>Pendentes</small>
          <b id="kPend">‚Äî</b>
        </div>
      </div>
    </div>

    <div style="height:12px"></div>

    <!-- VIEW: NOVO REGISTRO -->
    <div class="panel view active" id="viewNovo">
      <div class="row">
        <div>
          <label>Atividade</label>
          <input id="atividade" list="dlAtividades" placeholder="Digite para filtrar..." />
          <datalist id="dlAtividades"></datalist>
          <div class="hint" id="hintNew" style="display:none">
            N√£o encontrou? <a href="#" id="btnAddAtv">‚ûï Incluir novo</a>
          </div>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Rodovia</label>
          <input id="rodovia" placeholder="Ex.: PR-082" />
          <div class="hint">Se a atividade tiver rodovia no cat√°logo, preenche automaticamente.</div>
        </div>
        <div>
          <label>Total (m)</label>
          <input id="total" inputmode="decimal" placeholder="Ex.: 10,5" />
          <div class="hint">Use n√∫meros e v√≠rgula.</div>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Prazo de</label>
          <input id="prazoDe" type="date" />
        </div>
        <div>
          <label>Prazo at√©</label>
          <input id="prazoAte" type="date" />
        </div>
      </div>

      <div class="row">
        <div>
          <label>Foto (obrigat√≥ria)</label>
          <input id="foto" type="file" accept="image/*" capture="environment" />
          <div class="hint">Tire a foto no local. O sistema compacta para enviar mais r√°pido.</div>
        </div>
      </div>

      <div class="row">
        <button class="btn" id="btnSalvar">Salvar</button>
        <button class="btn secondary" id="btnAtualizarAtv">Atualizar atividades</button>
      </div>

      <div class="hint" id="saveMsg"></div>
    </div>

    <!-- VIEW: MEUS ENVIOS -->
    <div class="panel view" id="viewMeus">
      <div class="row">
        <button class="btn secondary" id="btnRefreshList">Atualizar lista</button>
        <button class="btn" id="btnResend">Reenviar pendentes</button>
      </div>
      <div class="sep"></div>
      <div class="list" id="list"></div>
    </div>

  </div>

<script>
/* ==========================================================
   CONFIG (igual ao seu index.html / primeiro_acesso.html)
========================================================== */
const WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbzbUN-2Heaogs0140LZGJEctnNW85aTxHJmGPatf-rTn1Ze_JM6bCA_BsVRvMiYPwuLDA/exec';

// cache das atividades (texto) ‚Äî offline r√°pido
const CACHE_ACTIVITIES_KEY = 'PAVI_FAST_ACTIVIDADES_CACHE_V1';

// sess√£o simples (salva no login)
const LS_USER = 'PAVI_FAST_USER';
const LS_NAME = 'PAVI_FAST_NAME';

/* ==========================================================
   Helpers
========================================================== */
const $ = (s)=>document.querySelector(s);
const $$ = (s)=>Array.from(document.querySelectorAll(s));

function setOnlineBadge(){
  $('#netBadge').textContent = navigator.onLine ? 'Online' : 'Offline (usando cache)';
}
window.addEventListener('online', setOnlineBadge);
window.addEventListener('offline', setOnlineBadge);

function showView(which){
  $('#viewNovo').classList.toggle('active', which==='novo');
  $('#viewMeus').classList.toggle('active', which==='meus');
  $('#viewTitle').textContent = (which==='novo') ? 'Novo registro' : 'Meus envios';
}

function toast(msg){ alert(msg); }

function normalizeNumberBR(str){
  if (typeof str !== 'string') str = String(str ?? '');
  const s = str.trim().replace(/\./g,'').replace(',','.');
  const n = Number(s);
  return Number.isFinite(n) ? n : null;
}

function toBRDateTime(ts){
  try { return new Date(ts).toLocaleString('pt-BR'); }
  catch { return String(ts); }
}

/* ==========================================================
   Drawer
========================================================== */
function drawer(open){
  $('#drawer').classList.toggle('open', open);
  $('#backdrop').classList.toggle('open', open);
}
$('#btnMenu').onclick = ()=>drawer(true);
$('#backdrop').onclick = ()=>drawer(false);

$$('[data-nav]').forEach(a=>{
  a.addEventListener('click', async (e)=>{
    e.preventDefault();
    const nav = a.getAttribute('data-nav');
    drawer(false);

    if(nav==='novo') showView('novo');
    if(nav==='meus'){ showView('meus'); await renderQueue(); }
    if(nav==='sync'){ await resendAll(); await renderQueue(); }
    if(nav==='logout'){
      localStorage.removeItem(LS_USER);
      localStorage.removeItem(LS_NAME);
      window.location.href = 'index.html';
    }
  });
});

/* ==========================================================
   IndexedDB (fila offline com foto)
========================================================== */
const DB_NAME = 'pavi_fast_db_v1';
const STORE = 'queue';

function openDB(){
  return new Promise((resolve, reject)=>{
    const req = indexedDB.open(DB_NAME, 1);
    req.onupgradeneeded = ()=>{
      const db = req.result;
      if(!db.objectStoreNames.contains(STORE)){
        db.createObjectStore(STORE, { keyPath:'id' });
      }
    };
    req.onsuccess = ()=>resolve(req.result);
    req.onerror = ()=>reject(req.error);
  });
}
async function idbPut(obj){
  const db = await openDB();
  return new Promise((resolve, reject)=>{
    const tx = db.transaction(STORE,'readwrite');
    tx.objectStore(STORE).put(obj);
    tx.oncomplete = ()=>resolve(true);
    tx.onerror = ()=>reject(tx.error);
  });
}
async function idbGetAll(){
  const db = await openDB();
  return new Promise((resolve, reject)=>{
    const tx = db.transaction(STORE,'readonly');
    const req = tx.objectStore(STORE).getAll();
    req.onsuccess = ()=>resolve(req.result||[]);
    req.onerror = ()=>reject(req.error);
  });
}
async function idbDel(id){
  const db = await openDB();
  return new Promise((resolve, reject)=>{
    const tx = db.transaction(STORE,'readwrite');
    tx.objectStore(STORE).delete(id);
    tx.oncomplete = ()=>resolve(true);
    tx.onerror = ()=>reject(tx.error);
  });
}

/* ==========================================================
   Cat√°logo de atividades (Sheets -> cache)
   Esperado: { status:"OK", itens:[{atividade:"...", rodovia:"..."}] }
   Se seu Apps Script devolver outro formato, me diga o JSON e eu ajusto em 2 min.
========================================================== */
let activities = [];

function loadActivitiesCache(){
  try{
    const raw = localStorage.getItem(CACHE_ACTIVITIES_KEY);
    if(!raw) return [];
    return JSON.parse(raw);
  }catch{ return []; }
}
function saveActivitiesCache(list){
  localStorage.setItem(CACHE_ACTIVITIES_KEY, JSON.stringify(list));
}

function fillDatalist(list){
  const dl = $('#dlAtividades');
  dl.innerHTML = '';
  list.forEach(it=>{
    const opt = document.createElement('option');
    opt.value = it.atividade;
    dl.appendChild(opt);
  });
  $('#kAct').textContent = String(list.length);
}

function pickRodoviaByAtividade(name){
  const v = (name||'').trim().toLowerCase();
  const it = activities.find(x => (x.atividade||'').trim().toLowerCase() === v);
  return it?.rodovia || '';
}

async function fetchActivities(){
  // POST form-urlencoded (igual seu login, evita preflight)
  const body = new URLSearchParams({ action:'activities' });
  const resp = await fetch(WEBAPP_URL, { method:'POST', body });
  const text = await resp.text();
  let json=null; try{ json = JSON.parse(text); }catch{}
  if(!resp.ok) throw new Error(json?.mensagem || text || ('HTTP '+resp.status));
  if(!json || json.status!=='OK') throw new Error(json?.mensagem || 'Falha ao carregar atividades');
  // json.itens: [{atividade, rodovia}]
  return json.itens || [];
}

async function refreshActivities(){
  try{
    const list = await fetchActivities();
    activities = list;
    saveActivitiesCache(list);
    fillDatalist(list);
    toast('Atividades atualizadas.');
  }catch(err){
    // se falhar, mant√©m cache
    console.warn(err);
    toast('N√£o foi poss√≠vel atualizar agora. Usando cache.');
  }
}

// sugerir incluir novo
$('#atividade').addEventListener('input', ()=>{
  const v = $('#atividade').value.trim().toLowerCase();
  if(!v){ $('#hintNew').style.display='none'; return; }
  const match = activities.some(x => (x.atividade||'').toLowerCase() === v);
  $('#hintNew').style.display = match ? 'none' : 'block';
});

// autopreenche rodovia
$('#atividade').addEventListener('change', ()=>{
  const rod = pickRodoviaByAtividade($('#atividade').value);
  if(rod) $('#rodovia').value = rod;
});

// incluir novo (online)
$('#btnAddAtv').addEventListener('click', async (e)=>{
  e.preventDefault();
  const atv = $('#atividade').value.trim();
  if(!atv) return;
  const rod = $('#rodovia').value.trim();
  if(!navigator.onLine) return toast('Sem internet para incluir agora.');

  if(!confirm(`Incluir nova atividade?\n\n${atv}`)) return;

  try{
    const body = new URLSearchParams({ action:'add_activity', atividade:atv, rodovia:rod });
    const resp = await fetch(WEBAPP_URL, { method:'POST', body });
    const text = await resp.text();
    let json=null; try{ json = JSON.parse(text); }catch{}
    if(!resp.ok) throw new Error(json?.mensagem || text || ('HTTP '+resp.status));
    if(!json || json.status!=='OK') throw new Error(json?.mensagem || 'Falha ao incluir');
    await refreshActivities();
  }catch(err){
    toast('Erro: ' + err.message);
  }
});

/* ==========================================================
   Foto: compress√£o para base64 JPEG
========================================================== */
async function compressToDataURL(file, maxW=1280, quality=0.75){
  const img = await new Promise((res, rej)=>{
    const i = new Image();
    i.onload = ()=>res(i);
    i.onerror = rej;
    i.src = URL.createObjectURL(file);
  });

  const scale = Math.min(1, maxW / img.width);
  const w = Math.round(img.width * scale);
  const h = Math.round(img.height * scale);

  const canvas = document.createElement('canvas');
  canvas.width = w; canvas.height = h;
  const ctx = canvas.getContext('2d');
  ctx.drawImage(img, 0, 0, w, h);

  const dataUrl = canvas.toDataURL('image/jpeg', quality);
  URL.revokeObjectURL(img.src);
  return dataUrl;
}

/* ==========================================================
   Envio (submit) para Apps Script
   Esperado: { status:"OK" } quando gravar no Sheets
========================================================== */
async function sendOne(rec){
  if(!navigator.onLine){
    rec.status = 'PENDING';
    rec.errorMsg = 'Sem internet';
    await idbPut(rec);
    return;
  }

  try{
    const body = new URLSearchParams({
      action:'submit',
      usuario: rec.usuario,
      nome: rec.nome,
      atividade: rec.atividade,
      rodovia: rec.rodovia,
      prazoDe: rec.prazoDe || '',
      prazoAte: rec.prazoAte || '',
      total: String(rec.totalBR || rec.total || ''),
      foto: rec.photoDataUrl // base64 dataURL
    });

    const resp = await fetch(WEBAPP_URL, { method:'POST', body });
    const text = await resp.text();
    let json=null; try{ json = JSON.parse(text); }catch{}

    if(!resp.ok) throw new Error(json?.mensagem || text || ('HTTP '+resp.status));
    if(!json || json.status!=='OK') throw new Error(json?.mensagem || 'Falha ao enviar');

    // enviado: remove da fila
    await idbDel(rec.id);
  }catch(err){
    rec.status = 'ERROR';
    rec.errorMsg = err.message || 'Erro';
    await idbPut(rec);
  }
}

async function resendAll(){
  const all = await idbGetAll();
  for(const rec of all){
    await sendOne(rec);
  }
  toast('Reenvio conclu√≠do. Confira pendentes/erros.');
}

async function getPendingCount(){
  const all = await idbGetAll();
  return all.length;
}

/* ==========================================================
   Lista (Meus envios)
========================================================== */
async function renderQueue(){
  const list = $('#list');
  const all = (await idbGetAll()).sort((a,b)=>(b.createdAt||0)-(a.createdAt||0));
  $('#kPend').textContent = String(all.length);

  list.innerHTML = '';
  if(all.length === 0){
    list.innerHTML = `<div class="item"><b>Nenhum envio pendente.</b><div class="meta">Tudo sincronizado.</div></div>`;
    return;
  }

  all.forEach(rec=>{
    const pillClass = rec.status==='ERROR' ? 'err' : (rec.status==='SENT' ? 'ok' : 'warn');
    const pillLabel = rec.status==='ERROR' ? 'Erro' : (rec.status==='SENT' ? 'Enviado' : 'Pendente');

    const el = document.createElement('div');
    el.className = 'item';
    el.innerHTML = `
      <div class="itemTop">
        <div>
          <b>${rec.atividade || '‚Äî'}</b>
          <div class="meta">${toBRDateTime(rec.createdAt)} ‚Ä¢ Total: ${rec.totalBR || rec.total || '‚Äî'} m</div>
        </div>
        <span class="pill ${pillClass}">${pillLabel}</span>
      </div>
      <div class="meta">Rodovia: ${rec.rodovia || '‚Äî'} ‚Ä¢ Prazo: ${rec.prazoDe || '‚Äî'} ‚Üí ${rec.prazoAte || '‚Äî'}</div>
      ${rec.errorMsg ? `<div class="meta" style="color:#991b1b;font-weight:800;margin-top:6px">Erro: ${rec.errorMsg}</div>` : ``}
      <div class="actions">
        <button class="btn secondary" data-act="detail" data-id="${rec.id}">Ver detalhe</button>
        <button class="btn" data-act="send" data-id="${rec.id}">Enviar</button>
        <button class="btn danger" data-act="del" data-id="${rec.id}">Excluir</button>
      </div>
    `;
    list.appendChild(el);
  });

  list.querySelectorAll('button[data-act]').forEach(btn=>{
    btn.addEventListener('click', async ()=>{
      const act = btn.getAttribute('data-act');
      const id = btn.getAttribute('data-id');
      const all = await idbGetAll();
      const rec = all.find(x=>x.id===id);
      if(!rec) return;

      if(act==='detail'){
        toast(
          `Atividade: ${rec.atividade}\nRodovia: ${rec.rodovia || '‚Äî'}\nTotal: ${rec.totalBR || rec.total}\nPrazo: ${rec.prazoDe || '‚Äî'} at√© ${rec.prazoAte || '‚Äî'}\nStatus: ${rec.status}\n${rec.errorMsg?('Erro: '+rec.errorMsg):''}`
        );
      }
      if(act==='send'){
        await sendOne(rec);
        await renderQueue();
      }
      if(act==='del'){
        if(confirm('Excluir este pendente?')){
          await idbDel(id);
          await renderQueue();
        }
      }
    });
  });
}

/* ==========================================================
   Eventos dos bot√µes
========================================================== */
$('#btnResend').addEventListener('click', async ()=>{ await resendAll(); await renderQueue(); });
$('#btnRefreshList').addEventListener('click', async ()=>{ await renderQueue(); });
$('#btnAtualizarAtv').addEventListener('click', async ()=>{ await refreshActivities(); });

$('#btnSalvar').addEventListener('click', async ()=>{
  const usuario = localStorage.getItem(LS_USER) || '';
  const nome = localStorage.getItem(LS_NAME) || usuario;

  const atividade = $('#atividade').value.trim();
  const rodovia = $('#rodovia').value.trim();
  const totalBR = $('#total').value.trim();
  const prazoDe = $('#prazoDe').value;
  const prazoAte = $('#prazoAte').value;
  const file = $('#foto').files?.[0];

  if(!atividade) return toast('Informe a atividade.');
  if(!totalBR) return toast('Informe o total.');
  if(!file) return toast('Foto √© obrigat√≥ria.');

  const total = normalizeNumberBR(totalBR);
  if(total === null) return toast('Total inv√°lido. Use n√∫mero e v√≠rgula.');

  $('#btnSalvar').disabled = true;
  $('#saveMsg').textContent = 'Processando foto...';

  try{
    const photoDataUrl = await compressToDataURL(file);

    const rec = {
      id: (crypto?.randomUUID ? crypto.randomUUID() : String(Date.now()) + '_' + Math.random()),
      createdAt: Date.now(),
      status: 'PENDING',
      errorMsg: '',
      usuario, nome,
      atividade, rodovia,
      prazoDe, prazoAte,
      total, totalBR,
      unidade: 'm',
      photoDataUrl
    };

    await idbPut(rec);

    // limpa
    $('#atividade').value='';
    $('#rodovia').value='';
    $('#total').value='';
    $('#prazoDe').value='';
    $('#prazoAte').value='';
    $('#foto').value='';

    $('#saveMsg').textContent = '';
    $('#kPend').textContent = String(await getPendingCount());

    // tenta enviar j√° (se online)
    await sendOne(rec);
    $('#kPend').textContent = String(await getPendingCount());

    toast('Registro salvo.');
  }catch(err){
    toast('Erro: ' + err.message);
  }finally{
    $('#btnSalvar').disabled = false;
    $('#saveMsg').textContent = '';
  }
});

/* ==========================================================
   Init
========================================================== */
(async function init(){
  // sess√£o m√≠nima
  const usuario = localStorage.getItem(LS_USER);
  const nome = localStorage.getItem(LS_NAME) || usuario;

  if(!usuario){
    // sem sess√£o: volta pro login
    window.location.href = 'index.html';
    return;
  }

  $('#who').textContent = nome || usuario;
  $('#kUser').textContent = nome || usuario;

  setOnlineBadge();

  // carrega cache instant√¢neo
  activities = loadActivitiesCache();
  fillDatalist(activities);

  $('#kPend').textContent = String(await getPendingCount());

  // sempre tenta atualizar ao abrir (se online)
  if(navigator.onLine){
    await refreshActivities();
  }
})();
</script>

</body>
</html>
